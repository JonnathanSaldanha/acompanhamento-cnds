<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Acompanhamento de CNDs</title>
<style>
:root {
  --bg: #F8FAFC;
  --card: #FFFFFF;
  --line: #E2E8F0;
  --muted: #64748B;
  --text: #0F172A;
  --ok: #059669;
  --warn: #D97706;
  --bad: #DC2626;
  --na: #94A3B8;
  --eletro-blue: #0033A0;
  --eletro-yellow: #FFB81C;
  --eletro-orange: #FF6B00;
  --shadow: 0 3px 10px -1px rgba(0, 0, 0, 0.08), 0 2px 6px -1px rgba(0, 0, 0, 0.04);
  --radius: 8px;
  --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  --gradient: linear-gradient(135deg, #0033A0, #0066CC);
  --gradient-light: linear-gradient(135deg, #0047BB, #0088FF);
  --gradient-card: linear-gradient(135deg, #FFFFFF, #F8FAFC);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  height: 100%;
  /* Patronização de fontes */
  font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
}

body {
  background: var(--bg);
  color: var(--text);
  font-size: 14px;
  line-height: 1.4;
}

/* Header mais compacto mas com tamanho aumentado */
header {
  background: var(--gradient);
  color: white;
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: 0 2px 12px rgba(0, 51, 160, 0.2);
  position: sticky;
  top: 0;
  z-index: 100;
  transition: var(--transition);
}

header:hover {
  box-shadow: 0 4px 16px rgba(0, 51, 160, 0.25);
}

.logo {
  width: 32px;
  height: 32px;
  border-radius: 6px;
  background: var(--eletro-yellow);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--eletro-blue);
  font-weight: bold;
  font-size: 14px;
  box-shadow: 0 2px 8px rgba(255, 184, 28, 0.3);
  transition: var(--transition);
}

.logo:hover {
  transform: scale(1.05) rotate(5deg);
  box-shadow: 0 4px 12px rgba(255, 184, 28, 0.4);
}

.title {
  font-size: 18px;
  font-weight: 700;
  letter-spacing: -0.01em;
  transition: var(--transition);
}

/* Main content com tamanho aumentado */
main {
  padding: 18px;
  max-width: 1440px;
  margin: 0 auto;
  width: 100%;
}

/* Tabs com tamanho aumentado e mais transições */
nav.tabs {
  background: white;
  border-radius: var(--radius);
  padding: 4px;
  display: inline-flex;
  gap: 2px;
  margin-bottom: 18px;
  box-shadow: var(--shadow);
  border: 1px solid var(--line);
  transition: var(--transition);
}

nav.tabs:hover {
  box-shadow: 0 4px 14px rgba(0, 0, 0, 0.1);
  transform: translateY(-1px);
}

.tabs button {
  background: transparent;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  color: var(--muted);
  transition: var(--transition);
  position: relative;
  overflow: hidden;
  font-size: 13px;
}

.tabs button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: var(--gradient-light);
  transition: var(--transition);
  z-index: -1;
}

.tabs button:hover {
  color: var(--eletro-blue);
  transform: translateY(-2px);
}

.tabs button:hover::before {
  left: 0;
  opacity: 0.1;
}

.tabs button.active {
  background: var(--gradient);
  color: white;
  box-shadow: 0 2px 8px rgba(0, 51, 160, 0.25);
  transform: translateY(0);
}

.tabs button.active:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 51, 160, 0.3);
}

/* KPIs com tamanho aumentado */
.kpis {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 14px;
  margin: 18px 0;
}

.card {
  background: var(--gradient-card);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  padding: 18px;
  box-shadow: var(--shadow);
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--gradient);
  opacity: 0;
  transition: var(--transition);
  z-index: 0;
}

.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
}

.card:hover::before {
  opacity: 0.04;
}

.card h4 {
  margin: 0 0 8px;
  color: var(--muted);
  font-weight: 600;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
  position: relative;
  z-index: 1;
  transition: var(--transition);
}

.card .v {
  font-size: 24px;
  font-weight: 800;
  color: var(--eletro-blue);
  position: relative;
  z-index: 1;
  transition: var(--transition);
}

.card.kpi {
  cursor: pointer;
}

.card.kpi.active {
  box-shadow: 0 0 0 3px rgba(0, 51, 160, 0.2);
  border-color: var(--eletro-blue);
  transform: scale(1.02);
}

/* Cards com cores específicas */
.card.kpi.total { border-left: 3px solid var(--eletro-blue); }
.card.kpi.regular { border-left: 3px solid var(--ok); }
.card.kpi.irregular { border-left: 3px solid var(--bad); }
.card.kpi.atencao { border-left: 3px solid var(--eletro-orange); }

/* Controls com tamanho aumentado */
.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin: 18px 0;
  align-items: center;
  padding: 16px;
  background: white;
  border-radius: var(--radius);
  border: 1px solid var(--line);
  box-shadow: var(--shadow);
  transition: var(--transition);
}

.controls:hover {
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
  transform: translateY(-1px);
}

.controls .sep {
  height: 20px;
  border-left: 1px solid var(--line);
  transition: var(--transition);
}

input[type="search"], select, button {
  background: white;
  border: 1px solid var(--line);
  border-radius: 6px;
  padding: 8px 12px;
  font-size: 13px;
  transition: var(--transition);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  font-family: inherit;
}

input[type="search"]:focus, select:focus {
  outline: none;
  border-color: var(--eletro-blue);
  box-shadow: 0 0 0 3px rgba(0, 51, 160, 0.15);
  transform: translateY(-1px);
}

button {
  cursor: pointer;
  font-weight: 600;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
  font-size: 13px;
  font-family: inherit;
  /* CORREÇÃO: Garantir que botões não fiquem desativados */
  pointer-events: auto !important;
  opacity: 1 !important;
}

button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: var(--gradient);
  transition: var(--transition);
  z-index: -1;
  opacity: 0;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

button:hover::before {
  left: 0;
  opacity: 0.1;
}

.btn-primary {
  background: var(--gradient);
  color: white;
  border: none;
  box-shadow: 0 2px 8px rgba(0, 51, 160, 0.2);
}

.btn-primary:hover {
  background: var(--gradient-light);
  box-shadow: 0 4px 14px rgba(0, 51, 160, 0.3);
  transform: translateY(-2px);
}

.btn-ghost {
  background: white;
  color: var(--text);
  border: 1px solid var(--line);
}

.btn-ghost:hover {
  background: #F8FAFC;
  border-color: var(--eletro-blue);
  color: var(--eletro-blue);
}

/* Badges com tamanho aumentado */
.badge {
  padding: 4px 8px;
  border-radius: 14px;
  font-size: 11px;
  font-weight: 600;
  display: inline-flex;
  gap: 4px;
  align-items: center;
  white-space: nowrap;
  transition: var(--transition);
  line-height: 1;
}

.badge:hover {
  transform: scale(1.05) translateY(-1px);
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.badge.regular {
  background: rgba(5, 150, 105, 0.1);
  color: #065F46;
  border: 1px solid rgba(5, 150, 105, 0.3);
}

.badge.irregular {
  background: rgba(220, 38, 38, 0.1);
  color: #7F1D1D;
  border: 1px solid rgba(220, 38, 38, 0.3);
}

.badge.atencao {
  background: rgba(255, 107, 0, 0.1);
  color: #7C2D12;
  border: 1px solid rgba(255, 107, 0, 0.3);
}

.badge.nao-verificada {
  background: rgba(148, 163, 184, 0.1);
  color: #374151;
  border: 1px solid rgba(148, 163, 184, 0.3);
}

/* Table com tamanho aumentado - CORREÇÃO DOS ÍCONES */
.table-container {
  background: white;
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow);
  border: 1px solid var(--line);
  transition: var(--transition);
}

.table-container:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
  transform: translateY(-1px);
}

.table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  font-size: 13px;
}

.table thead {
  background: #F8FAFC;
}

.table th {
  padding: 12px 10px;
  text-align: left;
  font-weight: 600;
  color: var(--muted);
  border-bottom: 1px solid var(--line);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  transition: var(--transition);
}

.table td {
  padding: 10px;
  border-bottom: 1px solid var(--line);
  transition: var(--transition);
  vertical-align: middle;
}

.table tbody tr {
  transition: var(--transition);
}

.table tbody tr:hover {
  transform: translateY(-2px);
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
}

.table tbody tr:hover td {
  background: #F8FAFC;
}

.row-actions {
  display: flex;
  gap: 6px;
  flex-wrap: nowrap;
  justify-content: center;
  align-items: center;
}

.sub {
  color: var(--muted);
  font-size: 11px;
  margin-top: 2px;
  line-height: 1.3;
}

/* Melhorias específicas para CNPJ - SEM QUEBRA DE LINHA */
.cnpj-cell {
  white-space: nowrap;
  font-family: 'SF Mono', 'Monaco', 'Consolas', 'Roboto Mono', monospace;
  font-size: 12px;
}

.empresa-cell {
  max-width: 200px;
  min-width: 160px;
}

.empresa-name {
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  display: block;
  font-size: 13px;
}

.local-info {
  display: flex;
  align-items: center;
  gap: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: 11px;
}

.ie-info {
  display: flex;
  align-items: center;
  gap: 4px;
  white-space: nowrap;
  font-size: 11px;
}

/* CORREÇÃO DOS BOTÕES DE AÇÃO - ÍCONES DENTRO DO ESQUADRO */
.btn-icon {
  width: 32px;
  height: 32px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  font-size: 14px;
  transition: var(--transition);
}

.btn-icon:hover {
  transform: scale(1.1) translateY(-1px);
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
}

.btn-icon-text {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  font-size: 12px;
  transition: var(--transition);
}

.btn-icon-text:hover {
  transform: translateY(-1px);
}

/* Modal com tamanho aumentado */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
  z-index: 1000;
  animation: fadeIn 0.3s ease-out;
}

.modal .box {
  width: min(920px, 95%);
  background: white;
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: 0 16px 40px -8px rgba(0, 0, 0, 0.25);
  border: 1px solid var(--line);
  animation: modalSlideIn 0.3s ease-out;
  max-height: 90vh;
  overflow-y: auto;
  transition: var(--transition);
}

.modal .box:hover {
  transform: translateY(-2px);
  box-shadow: 0 20px 50px -8px rgba(0, 0, 0, 0.3);
}

.modal h3 {
  margin: 0 0 18px;
  font-size: 22px;
  font-weight: 700;
  background: var(--gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  transition: var(--transition);
}

.grid-2, .grid-4 {
  display: grid;
  gap: 14px;
}

.grid-2 { grid-template-columns: 1fr 1fr; }
.grid-4 { grid-template-columns: repeat(4, 1fr); }

.field {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

label {
  color: var(--muted);
  font-weight: 600;
  font-size: 13px;
  transition: var(--transition);
}

hr.sep {
  border: none;
  border-top: 1px solid var(--line);
  margin: 18px 0;
  transition: var(--transition);
}

.footer {
  margin-top: 18px;
  color: var(--muted);
  font-size: 11px;
  text-align: center;
  padding: 14px;
  background: #F8FAFC;
  border-radius: var(--radius);
  transition: var(--transition);
}

.footer:hover {
  background: #F1F5F9;
}

/* Toast com tamanho aumentado */
.toast {
  position: fixed;
  right: 20px;
  bottom: 20px;
  background: white;
  color: var(--text);
  padding: 14px 18px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 1px solid var(--line);
  opacity: 0;
  transform: translateY(20px) scale(0.95);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 8px;
  border-left: 4px solid var(--ok);
  font-size: 13px;
}

.toast.show {
  opacity: 1;
  transform: translateY(0) scale(1);
}

.toast:hover {
  transform: translateY(-2px) scale(1);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

/* KPI dots */
.kpi-dot {
  display: inline-block;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  transition: var(--transition);
}

.dot-regular { background: var(--ok); }
.dot-atencao { background: var(--eletro-orange); }
.dot-irregular { background: var(--bad); }

/* Charts com tamanho aumentado */
.chart {
  background: white;
  border: 1px solid var(--line);
  border-radius: var(--radius);
  padding: 18px;
  box-shadow: var(--shadow);
  transition: var(--transition);
}

.chart:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.chart h5 {
  margin: 0 0 14px;
  color: var(--muted);
  font-weight: 600;
  font-size: 15px;
  transition: var(--transition);
}

.canvas {
  width: 100%;
  height: 240px;
  transition: var(--transition);
}

.grid-2c {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 18px;
}

/* Progress indicator */
.progress {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 3px;
  background: var(--gradient);
  z-index: 2000;
  animation: progress 2s infinite;
}

/* Mobile menu */
.mobile-menu {
  display: none;
  position: relative;
}

.mobile-menu-content {
  display: none;
  position: absolute;
  top: 100%;
  right: 0;
  background: white;
  border: 1px solid var(--line);
  border-radius: var(--radius);
  padding: 8px;
  box-shadow: var(--shadow);
  z-index: 25;
  min-width: 160px;
  animation: fadeInUp 0.3s ease;
  transition: var(--transition);
}

.mobile-menu-content.show {
  display: block;
}

.mobile-menu-content button {
  width: 100%;
  margin-bottom: 2px;
  text-align: left;
  font-size: 12px;
  padding: 6px 8px;
}

/* Status com validade */
.status-with-date {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.expiry-date {
  font-size: 10px;
  color: var(--muted);
  font-weight: 500;
  transition: var(--transition);
}

.expiry-date.expired {
  color: var(--bad);
  font-weight: 600;
}

.expiry-date.warning {
  color: var(--eletro-orange);
  font-weight: 600;
}

.expiry-date.valid {
  color: var(--ok);
  font-weight: 600;
}

.expiry-date.today {
  color: var(--eletro-blue);
  font-weight: 600;
}

/* CORREÇÃO: Estilos para paginação */
.paginacao {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  margin: 15px 0;
  padding: 10px;
  background: white;
  border-radius: var(--radius);
  border: 1px solid var(--line);
}

.btn-pagina {
  background: white;
  border: 1px solid var(--line);
  border-radius: 6px;
  padding: 6px 12px;
  font-size: 12px;
  cursor: pointer;
  transition: var(--transition);
}

.btn-pagina:hover:not(.disabled) {
  background: #F8FAFC;
  border-color: var(--eletro-blue);
  color: var(--eletro-blue);
  transform: translateY(-1px);
}

.btn-pagina.disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

/* Animações melhoradas */
@keyframes fadeIn {
  from { 
    opacity: 0; 
    transform: scale(0.95);
  }
  to { 
    opacity: 1; 
    transform: scale(1);
  }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-20px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

@keyframes progress {
  0% { transform: translateX(-100%); }
  50% { transform: translateX(0%); }
  100% { transform: translateX(100%); }
}

/* Efeitos de shimmer para loading */
.shimmer {
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}

/* Responsive */
@media (max-width: 1200px) {
  .grid-4 {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 1024px) {
  .kpis {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .grid-2c {
    grid-template-columns: 1fr;
  }
  
  header .row-actions {
    display: none;
  }
  
  .mobile-menu {
    display: block;
  }
}

@media (max-width: 768px) {
  main {
    padding: 14px;
  }
  
  .grid-2, .grid-4 {
    grid-template-columns: 1fr;
  }
  
  .table-container {
    overflow-x: auto;
  }
  
  .controls {
    flex-direction: column;
    align-items: stretch;
  }
  
  .controls .sep {
    display: none;
  }
  
  .row-actions {
    flex-direction: column;
  }
  
  .kpis {
    grid-template-columns: 1fr;
  }
  
  /* Ajustes específicos para mobile na tabela */
  .table th, .table td {
    padding: 8px 6px;
  }
  
  .empresa-cell {
    max-width: 140px;
    min-width: 120px;
  }
  
  .btn-icon-text span {
    display: none;
  }
  
  .btn-icon-text {
    width: 32px;
    padding: 0;
    justify-content: center;
  }
}

/* Botões com ícones */
.btn-with-icon {
  display: flex;
  align-items: center;
  gap: 6px;
  transition: var(--transition);
}

/* Efeito de pulso para elementos importantes */
.pulse {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(0, 51, 160, 0.4); }
  70% { box-shadow: 0 0 0 10px rgba(0, 51, 160, 0); }
  100% { box-shadow: 0 0 0 0 rgba(0, 51, 160, 0); }
}

/* Efeito de brilho para elementos ativos */
.glow {
  box-shadow: 0 0 10px rgba(0, 51, 160, 0.3);
  transition: var(--transition);
}

.glow:hover {
  box-shadow: 0 0 15px rgba(0, 51, 160, 0.5);
}

/* CORREÇÃO: Garantir que nenhum elemento esteja bloqueando interações */
body * {
  pointer-events: auto !important;
}

/* CORREÇÃO: Remover qualquer overlay que possa estar bloqueando */
.overlay-block {
  display: none !important;
}
</style>
</head>
<body>
  <div class="progress" id="progress"></div>
  
  <header>
    <div class="logo">CND</div>
    <div class="title">Acompanhamento de CNDs</div>
    <div style="margin-left:auto" class="row-actions">
      <button id="btnNovo" class="btn-primary btn-with-icon">
        <span>+</span> Novo
      </button>
      <button id="btnExportXLS" class="btn-ghost">Excel</button>
      <button id="btnExportCSV" class="btn-ghost">CSV</button>
      <button id="btnExport" class="btn-ghost">Backup</button>
      <button id="btnAutoBackup" class="btn-ghost">Auto Backup</button>
      <button id="btnImport" class="btn-ghost">Importar</button>
      <button id="btnRescue" class="btn-ghost">Recuperar</button>
      <button id="btnLimparStorage" class="btn-ghost" style="color: var(--bad)">🧹 Limpar Cache</button>
      <input id="importFile" type="file" accept="application/json" hidden />
    </div>
    
    <!-- Mobile menu -->
    <div class="mobile-menu">
      <button id="btnMobileMenu" class="btn-ghost">☰</button>
      <div class="mobile-menu-content" id="mobileMenuContent">
        <button id="btnNovoMobile" class="btn-ghost">+ Novo</button>
        <button id="btnExportXLSMobile" class="btn-ghost">Excel</button>
        <button id="btnExportCSVMobile" class="btn-ghost">CSV</button>
        <button id="btnExportMobile" class="btn-ghost">Backup</button>
        <button id="btnAutoBackupMobile" class="btn-ghost">Auto Backup</button>
        <button id="btnImportMobile" class="btn-ghost">Importar</button>
        <button id="btnRescueMobile" class="btn-ghost">Recuperar</button>
        <button id="btnLimparStorageMobile" class="btn-ghost" style="color: var(--bad)">Limpar Cache</button>
      </div>
    </div>
  </header>
  
  <main>
    <nav class="tabs">
      <button class="active" data-tab="lista">
        <span>📋</span> Lista
      </button>
      <button data-tab="dashboard">
        <span>📊</span> Dashboard
      </button>
    </nav>

    <section class="kpis" id="kpis"></section>

    <div class="controls" id="controls">
      <select id="empresaFilter"><option value="">Empresa (todas)</option></select>
      <select id="ufFilter"><option value="">UF (todas)</option></select>
      <select id="tipoCND"><option value="">Tipo de CND (todas)</option><option value="federal">Federal</option><option value="estadual">Estadual</option><option value="municipal">Municipal</option><option value="fgts">FGTS</option></select>
      <select id="statusFilter"><option value="">Status (todos)</option><option value="REGULAR">REGULAR</option><option value="IRREGULAR">IRREGULAR</option><option value="ATENCAO">ATENÇÃO</option><option value="NAO_VERIFICADA">NÃO VERIFICADA</option></select>
      <span class="sep"></span>
      <label style="color:var(--muted);font-weight:600">Modo:</label>
      <select id="mode"><option value="CADASTRO">Cadastros</option><option value="CNPJ">CNPJ</option></select>
      <button id="btnLimpar" class="btn-ghost">Limpar</button>
      <input type="search" id="q" placeholder="Buscar…"/>
    </div>

    <section id="view-lista">
      <div class="table-container">
        <table class="table" id="tbl">
          <thead id="thead"></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="footer">
        Sistema de acompanhamento de CNDs • Desenvolvido para gestão eficiente de certificados
      </div>
    </section>

    <section id="view-dashboard" style="display:none">
      <div class="grid-2c">
        <div class="chart">
          <h5>📈 Distribuição por Status</h5>
          <canvas id="chartStatus" class="canvas"></canvas>
        </div>
        <div class="chart">
          <h5>🗺️ Cadastros por UF (Top 12)</h5>
          <canvas id="chartUF" class="canvas"></canvas>
        </div>
      </div>
      <div class="footer">
        Dashboard interativo • Dados atualizados em tempo real
      </div>
    </section>
  </main>

  <div class="toast" id="toast">Alterações salvas com sucesso</div>

  <!-- Modal para cadastro/edição de empresa -->
  <div class="modal" id="modalEmpresa">
    <div class="box">
      <h3 id="modalEmpresaTitle">Novo Cadastro</h3>
      <div class="grid-2">
        <div class="field">
          <label>Empresa *</label>
          <input type="text" id="me_empresa" placeholder="Razão social" required>
        </div>
        <div class="field">
          <label>CNPJ *</label>
          <input type="text" id="me_cnpj" placeholder="Somente números" required>
        </div>
        <div class="field">
          <label>Município *</label>
          <input type="text" id="me_municipio" placeholder="Município" required>
        </div>
        <div class="field">
          <label>UF *</label>
          <select id="me_uf" required>
            <option value="">Selecione</option>
            <option value="AC">AC</option>
            <option value="AL">AL</option>
            <option value="AM">AM</option>
            <option value="AP">AP</option>
            <option value="BA">BA</option>
            <option value="CE">CE</option>
            <option value="DF">DF</option>
            <option value="ES">ES</option>
            <option value="GO">GO</option>
            <option value="MA">MA</option>
            <option value="MG">MG</option>
            <option value="MS">MS</option>
            <option value="MT">MT</option>
            <option value="PA">PA</option>
            <option value="PB">PB</option>
            <option value="PE">PE</option>
            <option value="PI">PI</option>
            <option value="PR">PR</option>
            <option value="RJ">RJ</option>
            <option value="RN">RN</option>
            <option value="RO">RO</option>
            <option value="RR">RR</option>
            <option value="RS">RS</option>
            <option value="SC">SC</option>
            <option value="SE">SE</option>
            <option value="SP">SP</option>
            <option value="TO">TO</option>
          </select>
        </div>
      </div>
      <div class="field">
        <label>Inscrição Estadual</label>
        <input type="text" id="me_ie" placeholder="Inscrição Estadual">
      </div>
      <hr class="sep">
      <div style="display: flex; gap: 8px; justify-content: flex-end">
        <button id="me_cancel" class="btn-ghost">Cancelar</button>
        <button id="me_save" class="btn-primary">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal para edição de CND -->
  <div class="modal" id="modalCND">
    <div class="box">
      <h3>Atualizar CND — <span id="mEmpresa"></span></h3>
      <div class="grid-4">
        <div class="field">
          <label>FEDERAL — Status</label>
          <select id="federal_status">
            <option value="REGULAR">REGULAR</option>
            <option value="IRREGULAR">IRREGULAR</option>
            <option value="OBS">ATENÇÃO</option>
            <option value="NÃO VERIFICADA">NÃO VERIFICADA</option>
          </select>
          <label>Validade</label>
          <input id="federal_validade" type="date">
          <div id="federal_update_info" class="expiry-date today" style="display:none">Atualizado hoje</div>
          <label>Link da certidão</label>
          <input id="federal_link" type="url" placeholder="https://…">
          <label>Observações</label>
          <input id="federal_obs" placeholder="Observações">
        </div>
        <div class="field">
          <label>ESTADUAL — Status</label>
          <select id="estadual_status">
            <option value="REGULAR">REGULAR</option>
            <option value="IRREGULAR">IRREGULAR</option>
            <option value="OBS">ATENÇÃO</option>
            <option value="NÃO VERIFICADA">NÃO VERIFICADA</option>
          </select>
          <label>Validade</label>
          <input id="estadual_validade" type="date">
          <div id="estadual_update_info" class="expiry-date today" style="display:none">Atualizado hoje</div>
          <label>Link da certidão</label>
          <input id="estadual_link" type="url" placeholder="https://…">
          <label>Observações</label>
          <input id="estadual_obs" placeholder="Observações">
        </div>
        <div class="field">
          <label>MUNICIPAL — Status</label>
          <select id="municipal_status">
            <option value="REGULAR">REGULAR</option>
            <option value="IRREGULAR">IRREGULAR</option>
            <option value="OBS">ATENÇÃO</option>
            <option value="NÃO VERIFICADA">NÃO VERIFICADA</option>
          </select>
          <label>Validade</label>
          <input id="municipal_validade" type="date">
          <div id="municipal_update_info" class="expiry-date today" style="display:none">Atualizado hoje</div>
          <label>Link da certidão</label>
          <input id="municipal_link" type="url" placeholder="https://…">
          <label>Observações</label>
          <input id="municipal_obs" placeholder="Observações">
        </div>
        <div class="field">
          <label>FGTS — Status</label>
          <select id="fgts_status">
            <option value="REGULAR">REGULAR</option>
            <option value="IRREGULAR">IRREGULAR</option>
            <option value="OBS">ATENÇÃO</option>
            <option value="NÃO VERIFICADA">NÃO VERIFICADA</option>
          </select>
          <label>Validade</label>
          <input id="fgts_validade" type="date">
          <div id="fgts_update_info" class="expiry-date today" style="display:none">Atualizado hoje</div>
          <label>Link da certidão</label>
          <input id="fgts_link" type="url" placeholder="https://…">
          <label>Observações</label>
          <input id="fgts_obs" placeholder="Observações">
        </div>
      </div>
      <hr class="sep">
      <div class="row-actions" style="justify-content: space-between">
        <div class="row-actions">
          <button id="btnEditarEmpresa" class="btn-ghost btn-icon-text">✏️ <span>Editar</span></button>
          <button id="btnExcluirEmpresa" class="btn-ghost btn-icon-text" style="color:#DC2626">🗑️ <span>Excluir</span></button>
        </div>
        <div class="row-actions">
          <button id="btnFechar" class="btn-ghost">Cancelar</button>
          <button id="btnSalvar" class="btn-primary">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
// ===== CORREÇÃO: Verificar se há algum elemento bloqueando =====
console.log('Inicializando sistema CND...');

// ===== Constantes & helpers =====
const STATUSES = ['REGULAR','IRREGULAR','OBS','NÃO VERIFICADA'];
const GROUPS = ['federal','estadual','municipal','fgts'];
const STORAGE_MASTER_KEY = 'cnds_data';
const LEGACY_KEYS = ['cnds_data_v3_2','cnds_data_v3_1','cnds_data_v3','cnds_data_v2'];
const ALL_UF = ['AC','AL','AM','AP','BA','CE','DF','ES','GO','MA','MG','MS','MT','PA','PB','PE','PI','PR','RJ','RN','RO','RR','RS','SC','SE','SP','TO'];

// ===== SISTEMA DE BACKUP SEGURO OTIMIZADO =====
const BACKUP_KEYS = {
  current: STORAGE_MASTER_KEY,
  backup1: 'cnds_backup_1',
  backup2: 'cnds_backup_2', 
  backup3: 'cnds_backup_3'
};

// Seletores DOM
const $ = (sel, root = document) => root.querySelector(sel);
const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

// Utilitários
const fmtCNPJ = c => c && c.length === 14 ? c.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5') : c;
const onlyDigits = s => String(s || '').replace(/\D/g, '');
const norm = s => String(s || '').trim().toUpperCase();
const uiStatus = s => s === 'OBS' ? 'ATENÇÃO' : s;
const isAtencao = s => s === 'OBS' || s === 'NÃO VERIFICADA';
const keyOf = e => [e.cnpj, norm(e.uf), norm(e.municipio), norm(e.inscricao_estadual)].join('|');
const showToast = (msg) => { 
  const t = $('#toast'); 
  t.textContent = msg || 'Alterações salvas'; 
  t.classList.add('show'); 
  setTimeout(() => t.classList.remove('show'), 3000); 
};

// Função para obter data atual no formato YYYY-MM-DD
const getToday = () => {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

// ===== VALIDAÇÃO REAL DE CNPJ =====
function validarCNPJ(cnpj) {
  cnpj = cnpj.replace(/[^\d]/g, '');
  
  if (cnpj.length !== 14) return false;
  
  // Elimina CNPJs inválidos conhecidos
  if (/^(\d)\1{13}$/.test(cnpj)) return false;
  
  // Valida DVs
  let tamanho = cnpj.length - 2;
  let numeros = cnpj.substring(0, tamanho);
  let digitos = cnpj.substring(tamanho);
  let soma = 0;
  let pos = tamanho - 7;
  
  for (let i = tamanho; i >= 1; i--) {
    soma += numeros.charAt(tamanho - i) * pos--;
    if (pos < 2) pos = 9;
  }
  
  let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
  if (resultado !== parseInt(digitos.charAt(0))) return false;
  
  tamanho = tamanho + 1;
  numeros = cnpj.substring(0, tamanho);
  soma = 0;
  pos = tamanho - 7;
  
  for (let i = tamanho; i >= 1; i--) {
    soma += numeros.charAt(tamanho - i) * pos--;
    if (pos < 2) pos = 9;
  }
  
  resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
  if (resultado !== parseInt(digitos.charAt(1))) return false;
  
  return true;
}

// ===== SISTEMA DE BACKUP SEGURO OTIMIZADO =====
function createSafeBackup() {
  try {
    const data = JSON.stringify(state, null, 2);
    
    // Verificar se os dados são muito grandes
    if (data.length > 4 * 1024 * 1024) { // 4MB
      console.warn('Dados muito grandes para backup completo, criando backup compactado');
      // Criar versão compactada sem espaços
      const compactData = JSON.stringify(state);
      
      // Rotação de backups (mantém apenas 2 versões para economizar espaço)
      const backup2 = localStorage.getItem(BACKUP_KEYS.backup1);
      if (backup2) localStorage.setItem(BACKUP_KEYS.backup2, backup2);
      
      localStorage.setItem(BACKUP_KEYS.backup1, compactData);
      return;
    }
    
    // Rotação de backups (mantém apenas 2 versões)
    const backup2 = localStorage.getItem(BACKUP_KEYS.backup1);
    if (backup2) localStorage.setItem(BACKUP_KEYS.backup2, backup2);
    
    localStorage.setItem(BACKUP_KEYS.backup1, data);
    
  } catch (e) {
    console.error('Erro no backup:', e);
    // Não quebrar o fluxo principal se o backup falhar
  }
}

// ===== FUNÇÃO DE LIMPEZA DE BACKUPS ANTIGOS =====
function limparBackupsAntigos() {
  try {
    const keysToRemove = [];
    
    // Verificar tamanho atual do localStorage
    let totalSize = 0;
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith('cnds_')) {
        const value = localStorage.getItem(key);
        totalSize += value ? value.length : 0;
        
        // Marcar backups muito antigos para remoção (exceto o atual)
        if (key !== STORAGE_MASTER_KEY && key !== BACKUP_KEYS.backup1) {
          keysToRemove.push(key);
        }
      }
    }
    
    // Se ainda estiver perto do limite, remover mais backups
    if (totalSize > 4 * 1024 * 1024) { // 4MB
      keysToRemove.push(BACKUP_KEYS.backup2);
    }
    
    // Remover chaves selecionadas
    keysToRemove.forEach(key => {
      localStorage.removeItem(key);
      console.log('Removido backup antigo:', key);
    });
    
    return keysToRemove.length;
    
  } catch (e) {
    console.error('Erro ao limpar backups:', e);
    return 0;
  }
}

// ===== CONTROLE DE ESPAÇO NO STORAGE =====
function verificarEspacoStorage() {
  try {
    let totalSize = 0;
    const items = [];
    
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      const value = localStorage.getItem(key);
      const size = value ? value.length : 0;
      totalSize += size;
      
      if (key && key.startsWith('cnds_')) {
        items.push({ key, size: (size / 1024).toFixed(2) + ' KB' });
      }
    }
    
    console.log('Uso total do storage:', (totalSize / 1024 / 1024).toFixed(2), 'MB');
    console.log('Itens CND:', items);
    
    return {
      totalMB: (totalSize / 1024 / 1024).toFixed(2),
      items: items
    };
  } catch (e) {
    console.error('Erro ao verificar storage:', e);
    return null;
  }
}

function restoreFromBackup(backupKey) {
  const backupData = load(backupKey);
  if (backupData && backupData.empresas && backupData.cnds) {
    return backupData;
  }
  return null;
}

function showRestoreOptions() {
  const backups = [];
  
  // Verificar quais backups existem
  Object.entries(BACKUP_KEYS).forEach(([name, key]) => {
    if (key !== STORAGE_MASTER_KEY) {
      const data = load(key);
      if (data) {
        const backupInfo = data._backupInfo || { timestamp: new Date().getTime() };
        const date = new Date(backupInfo.timestamp).toLocaleString('pt-BR');
        backups.push({ name: `Backup ${name.replace('backup', '')}`, key, date });
      }
    }
  });
  
  if (backups.length === 0) {
    alert('Nenhum backup encontrado para recuperação.');
    return;
  }
  
  // Criar interface simples para seleção
  let message = 'Selecione o backup para recuperar:\n\n';
  backups.forEach((backup, index) => {
    message += `${index + 1}. ${backup.name} (${backup.date})\n`;
  });
  
  const choice = prompt(message + '\nDigite o número do backup:');
  const selectedIndex = parseInt(choice) - 1;
  
  if (selectedIndex >= 0 && selectedIndex < backups.length) {
    const selectedBackup = backups[selectedIndex];
    if (confirm(`ATENÇÃO: Isso substituirá todos os dados atuais pelo ${selectedBackup.name}. Continuar?`)) {
      const restoredData = restoreFromBackup(selectedBackup.key);
      if (restoredData) {
        state = restoredData;
        save(STORAGE_MASTER_KEY, state);
        renderAll();
        refreshEmpresaFilter();
        showToast(`Backup ${selectedBackup.name} recuperado com sucesso!`);
      } else {
        alert('Erro ao recuperar backup. Dados corrompidos.');
      }
    }
  }
}

// ===== Estado & recuperação =====
function load(key) { 
  try { 
    return JSON.parse(localStorage.getItem(key) || 'null'); 
  } catch(e) { 
    return null; 
  } 
}

function save(key, value) { 
  try {
    // Adicionar informação de backup
    if (!value._backupInfo) {
      value._backupInfo = { 
        timestamp: new Date().getTime(), 
        version: value.schemaVersion || 4,
        size: JSON.stringify(value).length
      };
    }
    
    // Tentar salvar
    localStorage.setItem(key, JSON.stringify(value));
    
    if (key === STORAGE_MASTER_KEY) {
      // Limpar backups antigos antes de criar novo
      limparBackupsAntigos();
      createSafeBackup();
      autoSave();
    }
    
    return true;
    
  } catch (e) {
    if (e.name === 'QuotaExceededError') {
      console.error('Storage cheio, executando limpeza emergencial...');
      
      // Limpeza emergencial
      localStorage.removeItem(BACKUP_KEYS.backup3);
      localStorage.removeItem(BACKUP_KEYS.backup2);
      
      // Tentar novamente
      try {
        localStorage.setItem(key, JSON.stringify(value));
        showToast('Dados salvos (backups antigos removidos)');
        return true;
      } catch (e2) {
        console.error('Falha após limpeza emergencial:', e2);
        alert('ERRO: Storage cheio. Exporte seus dados e limpe o sistema.');
        return false;
      }
    }
    throw e;
  }
}

function seedFromEmbed() { 
  const empresas = [
    {
      empresa: "ELETROBRAS S.A.",
      cnpj: "00000000000191",
      municipio: "Rio de Janeiro",
      uf: "RJ",
      inscricao_estadual: "123456789"
    }
  ];
  
  const cnds = {};
  empresas.forEach(e => {
    cnds[keyOf(e)] = {
      federal: { status: 'NÃO VERIFICADA', validade: '', link: '', obs: '' },
      estadual: { status: 'NÃO VERIFICADA', validade: '', link: '', obs: '' },
      municipal: { status: 'NÃO VERIFICADA', validade: '', link: '', obs: '' },
      fgts: { status: 'NÃO VERIFICADA', validade: '', link: '', obs: '' }
    };
  });
  
  return { empresas, cnds, schemaVersion: 4 };
}

function migrateIfNeeded(state) {
  if (!state || !state.cnds || !state.empresas) return state;
  
  Object.keys(state.cnds).forEach(k => {
    GROUPS.forEach(g => {
      if (!state.cnds[k][g]) {
        state.cnds[k][g] = { status: 'NÃO VERIFICADA', validade: '', link: '', obs: '' };
      }
    });
  });
  
  state.schemaVersion = (state.schemaVersion || 3) + 1;
  return state;
}

function scanCandidates() {
  const found = [];
  if (localStorage.getItem(STORAGE_MASTER_KEY)) {
    found.push({ key: STORAGE_MASTER_KEY, label: 'Atual (cnds_data)' });
  }
  
  LEGACY_KEYS.forEach(k => {
    if (localStorage.getItem(k)) {
      found.push({ key: k, label: 'Antigo: ' + k });
    }
  });
  
  return found;
}

let state = load(STORAGE_MASTER_KEY);
if (!state) {
  const cands = scanCandidates();
  if (cands.length) {
    // Se há dados antigos, vamos carregar o primeiro disponível
    const firstCandidate = cands[0];
    state = migrateIfNeeded(load(firstCandidate.key));
    save(STORAGE_MASTER_KEY, state);
    showToast('Dados recuperados de ' + firstCandidate.key);
  } else {
    state = seedFromEmbed();
    save(STORAGE_MASTER_KEY, state);
  }
} else {
  state = migrateIfNeeded(state);
  save(STORAGE_MASTER_KEY, state);
}

// ===== PAGINAÇÃO =====
const ITENS_POR_PAGINA = 50;
let paginaAtual = 1;
let dadosFiltrados = [];

function setupPaginacao() {
  const paginacaoContainer = document.createElement('div');
  paginacaoContainer.className = 'paginacao';
  paginacaoContainer.style.cssText = `
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin: 15px 0;
    padding: 10px;
    background: white;
    border-radius: var(--radius);
    border: 1px solid var(--line);
  `;
  
  return paginacaoContainer;
}

function renderPaginacao() {
  const totalPaginas = Math.ceil(dadosFiltrados.length / ITENS_POR_PAGINA);
  
  if (totalPaginas <= 1) {
    const existingPagination = $('.paginacao');
    if (existingPagination) existingPagination.remove();
    return;
  }
  
  let paginacaoContainer = $('.paginacao');
  if (!paginacaoContainer) {
    paginacaoContainer = setupPaginacao();
    $('#view-lista').insertBefore(paginacaoContainer, $('.footer'));
  }
  
  paginacaoContainer.innerHTML = `
    <button class="btn-ghost btn-pagina ${paginaAtual === 1 ? 'disabled' : ''}" data-pagina="${paginaAtual - 1}">‹ Anterior</button>
    <span style="color: var(--muted); font-size: 12px;">
      Página ${paginaAtual} de ${totalPaginas} (${dadosFiltrados.length} itens)
    </span>
    <button class="btn-ghost btn-pagina ${paginaAtual === totalPaginas ? 'disabled' : ''}" data-pagina="${paginaAtual + 1}">Próxima ›</button>
  `;
  
  // Event listeners para paginação
  $$('.btn-pagina').forEach(btn => {
    btn.addEventListener('click', (e) => {
      if (btn.classList.contains('disabled')) return;
      paginaAtual = parseInt(e.target.dataset.pagina);
      renderTable();
    });
  });
}

function getDadosPagina() {
  const inicio = (paginaAtual - 1) * ITENS_POR_PAGINA;
  const fim = inicio + ITENS_POR_PAGINA;
  return dadosFiltrados.slice(inicio, fim);
}

// ===== Tabs =====
const tabs = $$('.tabs button');
const viewLista = $('#view-lista');
const viewDash = $('#view-dashboard');

tabs.forEach(b => {
  b.addEventListener('click', () => {
    tabs.forEach(x => x.classList.remove('active'));
    b.classList.add('active');
    const tab = b.dataset.tab;
    if (tab === 'lista') {
      viewLista.style.display = 'block';
      viewDash.style.display = 'none';
    } else {
      viewLista.style.display = 'none';
      viewDash.style.display = 'block';
      renderCharts();
    }
  });
});

// ===== UI refs =====
const tblHead = $('#thead');
const tblBody = $('#tbl tbody');
const q = $('#q');
const empresaFilter = $('#empresaFilter');
const ufFilter = $('#ufFilter');
const tipoCND = $('#tipoCND');
const statusFilter = $('#statusFilter');
const modeSel = $('#mode');

// Popular UF filter
ufFilter.innerHTML += ALL_UF.map(u => `<option value="${u}">${u}</option>`).join('');

function refreshEmpresaFilter() {
  const sel = empresaFilter.value;
  const names = Array.from(new Set((state.empresas || []).map(e => e.empresa).filter(Boolean))).sort((a, b) => a.localeCompare(b, 'pt-BR'));
  empresaFilter.innerHTML = '<option value="">Empresa (todas)</option>' + names.map(n => `<option value="${n.replace(/\"/g, '&quot;')}">${n}</option>`).join('');
  if (names.includes(sel)) empresaFilter.value = sel;
}
refreshEmpresaFilter();

// ===== Modais CRUD =====
let editingKey = null;

function openModalEmpresa(key) {
  editingKey = key || null;
  const modal = $('#modalEmpresa');
  const title = $('#modalEmpresaTitle');
  
  title.textContent = editingKey ? 'Editar Cadastro' : 'Novo Cadastro';
  
  if (editingKey) {
    const e = state.empresas.find(x => keyOf(x) === editingKey);
    $('#me_empresa').value = e.empresa || '';
    $('#me_cnpj').value = e.cnpj || '';
    $('#me_municipio').value = e.municipio || '';
    $('#me_uf').value = e.uf || '';
    $('#me_ie').value = e.inscricao_estadual || '';
  } else {
    $('#me_empresa').value = '';
    $('#me_cnpj').value = '';
    $('#me_municipio').value = '';
    $('#me_uf').value = '';
    $('#me_ie').value = '';
  }
  
  modal.style.display = 'flex';
}

function closeModalEmpresa() {
  $('#modalEmpresa').style.display = 'none';
  editingKey = null;
}

$('#modalEmpresa').addEventListener('click', (ev) => {
  if (ev.target === $('#modalEmpresa')) closeModalEmpresa();
});

$('#me_cancel').addEventListener('click', closeModalEmpresa);

$('#me_save').addEventListener('click', () => {
  const empresa = $('#me_empresa').value.trim();
  const cnpj = onlyDigits($('#me_cnpj').value);
  const municipio = $('#me_municipio').value.trim();
  const uf = $('#me_uf').value;
  const ie = $('#me_ie').value.trim();
  
  if (!empresa) {
    alert('Informe a razão social.');
    return;
  }
  
  // VALIDAÇÃO REAL DO CNPJ
  if (!/^\d{14}$/.test(cnpj)) {
    alert('CNPJ inválido (14 dígitos).');
    return;
  }
  
  if (!validarCNPJ(cnpj)) {
    alert('CNPJ inválido. Verifique os dígitos.');
    return;
  }
  
  if (!uf) {
    alert('Selecione a UF.');
    return;
  }
  
  const novo = { empresa, cnpj, municipio, uf, inscricao_estadual: ie };
  const newKey = keyOf(novo);
  
  if (editingKey) {
    // Edição
    if (editingKey !== newKey) {
      // Chave mudou, verificar se já existe
      const existe = state.empresas.some(e => keyOf(e) === newKey);
      if (existe) {
        alert('Já existe um cadastro com estes dados.');
        return;
      }
      
      // Remover antigo
      const idx = state.empresas.findIndex(x => keyOf(x) === editingKey);
      if (idx !== -1) {
        state.empresas.splice(idx, 1);
        delete state.cnds[editingKey];
      }
    }
  } else {
    // Novo cadastro - verificar se já existe
    const existe = state.empresas.some(e => keyOf(e) === newKey);
    if (existe) {
      alert('Já existe um cadastro com estes dados.');
      return;
    }
  }
  
  state.empresas.push(novo);
  if (!state.cnds[newKey]) {
    state.cnds[newKey] = {
      federal: { status: 'NÃO VERIFICADA', validade: '', link: '', obs: '' },
      estadual: { status: 'NÃO VERIFICADA', validade: '', link: '', obs: '' },
      municipal: { status: 'NÃO VERIFICADA', validade: '', link: '', obs: '' },
      fgts: { status: 'NÃO VERIFICADA', validade: '', link: '', obs: '' }
    };
  }
  
  save(STORAGE_MASTER_KEY, state);
  renderAll();
  refreshEmpresaFilter();
  closeModalEmpresa();
  showToast(editingKey ? 'Cadastro atualizado' : 'Cadastro criado');
});

let currentKey = null;

function openModalCND(key) {
  currentKey = key;
  const e = state.empresas.find(x => keyOf(x) === key);
  const rec = state.cnds[key] || {
    federal: { status: 'NÃO VERIFICADA', validade: '', link: '', obs: '' },
    estadual: { status: 'NÃO VERIFICADA', validade: '', link: '', obs: '' },
    municipal: { status: 'NÃO VERIFICADA', validade: '', link: '', obs: '' },
    fgts: { status: 'NÃO VERIFICADA', validade: '', link: '', obs: '' }
  };
  
  $('#mEmpresa').textContent = `${e.empresa} — ${fmtCNPJ(e.cnpj)}`;
  
  GROUPS.forEach(g => {
    const v = rec[g] || {};
    $(`#${g}_status`).value = v.status || 'NÃO VERIFICADA';
    $(`#${g}_validade`).value = v.validade || '';
    $(`#${g}_link`).value = v.link || '';
    $(`#${g}_obs`).value = v.obs || '';
    
    // Mostrar indicador se a validade foi atualizada hoje
    const updateInfo = $(`#${g}_update_info`);
    if (v.validade === getToday()) {
      updateInfo.style.display = 'block';
    } else {
      updateInfo.style.display = 'none';
    }
  });
  
  $('#modalCND').style.display = 'flex';
}

function closeModalCND() {
  $('#modalCND').style.display = 'none';
  currentKey = null;
}

$('#modalCND').addEventListener('click', (ev) => {
  if (ev.target === $('#modalCND')) closeModalCND();
});

$('#btnFechar').addEventListener('click', closeModalCND);

$('#btnSalvar').addEventListener('click', () => {
  if (!currentKey) return;
  
  GROUPS.forEach(g => {
    const currentStatus = $(`#${g}_status`).value;
    const currentValidade = $(`#${g}_validade`).value;
    
    // Se o status foi alterado, atualizar a validade para hoje
    const oldStatus = state.cnds[currentKey][g].status;
    let newValidade = currentValidade;
    
    if (currentStatus !== oldStatus) {
      newValidade = getToday();
      $(`#${g}_validade`).value = newValidade;
      $(`#${g}_update_info`).style.display = 'block';
    }
    
    state.cnds[currentKey][g] = {
      status: currentStatus,
      validade: newValidade,
      link: $(`#${g}_link`).value,
      obs: $(`#${g}_obs`).value,
      atualizadoEm: new Date().toISOString()
    };
  });
  
  save(STORAGE_MASTER_KEY, state);
  renderAll();
  closeModalCND();
  showToast('CNDs atualizadas');
});

$('#btnEditarEmpresa').addEventListener('click', () => {
  closeModalCND();
  openModalEmpresa(currentKey);
});

$('#btnExcluirEmpresa').addEventListener('click', () => {
  if (!currentKey) return;
  if (!confirm('Excluir este cadastro? Essa ação não pode ser desfeita.')) return;
  
  const idx = state.empresas.findIndex(x => keyOf(x) === currentKey);
  if (idx !== -1) state.empresas.splice(idx, 1);
  delete state.cnds[currentKey];
  
  save(STORAGE_MASTER_KEY, state);
  renderAll();
  closeModalCND();
  showToast('Cadastro excluído');
  refreshEmpresaFilter();
});

// ===== Filtros/KPIs/Tabela =====
let quick = null;

function rowStatus(key, g) {
  return (state.cnds[key] && state.cnds[key][g] && state.cnds[key][g].status) || 'NÃO VERIFICADA';
}

// CORREÇÃO: Função de filtro corrigida
function matchAllCadastro(e) {
  const term = q.value.trim().toLowerCase();
  const key = keyOf(e);
  
  const okEmpresa = !empresaFilter.value || e.empresa === empresaFilter.value;
  const okTerm = !term || [e.empresa, e.cnpj, e.municipio, e.uf, e.inscricao_estadual]
    .some(v => String(v || '').toLowerCase().includes(term));
  const okUF = !ufFilter.value || e.uf === ufFilter.value;
  
  const okStatus = (function() {
    const statusFilterValue = statusFilter.value;
    const tipoCNDValue = tipoCND.value;
    
    if (!statusFilterValue && !tipoCNDValue) return true;
    
    // Se há filtro de tipo CND específico
    if (tipoCNDValue) {
      const status = rowStatus(key, tipoCNDValue);
      if (!statusFilterValue) return true; // Apenas filtro por tipo
      
      // Filtro combinado: tipo CND + status
      if (statusFilterValue === 'ATENCAO') return isAtencao(status);
      if (statusFilterValue === 'NAO_VERIFICADA') return status === 'NÃO VERIFICADA';
      return status === statusFilterValue;
    }
    
    // Apenas filtro de status geral (pelo menos um CND com esse status)
    if (statusFilterValue === 'ATENCAO') {
      return GROUPS.some(g => isAtencao(rowStatus(key, g)));
    }
    if (statusFilterValue === 'NAO_VERIFICADA') {
      return GROUPS.some(g => rowStatus(key, g) === 'NÃO VERIFICADA');
    }
    return GROUPS.some(g => rowStatus(key, g) === statusFilterValue);
  })();
  
  return okEmpresa && okTerm && okUF && okStatus;
}

// CORREÇÃO: Função computeOverview corrigida
function computeOverview() {
  const filtered = state.empresas.filter(matchAllCadastro);
  const t = { total: filtered.length, regular: 0, irregular: 0, atencao: 0 };
  
  filtered.forEach(e => {
    const key = keyOf(e);
    const statuses = GROUPS.map(g => rowStatus(key, g));
    
    // Contar quantos CNDs de cada status existem nos filtrados
    statuses.forEach(status => {
      if (status === 'REGULAR') t.regular++;
      else if (status === 'IRREGULAR') t.irregular++;
      else if (isAtencao(status)) t.atencao++;
    });
  });
  
  return t;
}

function statusBadge(s) {
  return `<span class="badge ${(s === 'REGULAR') ? 'regular' : (s === 'IRREGULAR') ? 'irregular' : (isAtencao(s) ? 'atencao' : 'nao-verificada')}">${uiStatus(s)}</span>`;
}

function renderKPIs() {
  const t = computeOverview();
  const k = $('#kpis');
  
  k.innerHTML = `
    <div class="card total"><h4>Total de Cadastros</h4><div class="v">${t.total}</div></div>
    <div class="card kpi regular ${quick === 'REGULAR' ? 'active' : ''}" id="kpi-regular"><h4><span class="kpi-dot dot-regular"></span> CNDs REGULAR</h4><div class="v">${t.regular}</div></div>
    <div class="card kpi irregular ${quick === 'IRREGULAR' ? 'active' : ''}" id="kpi-irregular"><h4><span class="kpi-dot dot-irregular"></span> CNDs IRREGULAR</h4><div class="v">${t.irregular}</div></div>
    <div class="card kpi atencao ${quick === 'ATENCAO' ? 'active' : ''}" id="kpi-atencao"><h4><span class="kpi-dot dot-atencao"></span> CNDs ATENÇÃO</h4><div class="v">${t.atencao}</div></div>`;
    
  $('#kpi-regular').addEventListener('click', () => {
    quick = quick === 'REGULAR' ? null : 'REGULAR';
    statusFilter.value = quick === 'REGULAR' ? 'REGULAR' : '';
    renderAll();
  });
  
  $('#kpi-irregular').addEventListener('click', () => {
    quick = quick === 'IRREGULAR' ? null : 'IRREGULAR';
    statusFilter.value = quick === 'IRREGULAR' ? 'IRREGULAR' : '';
    renderAll();
  });
  
  $('#kpi-atencao').addEventListener('click', () => {
    quick = quick === 'ATENCAO' ? null : 'ATENCAO';
    statusFilter.value = quick === 'ATENCAO' ? 'ATENCAO' : '';
    renderAll();
  });
}

function renderTable() {
  dadosFiltrados = state.empresas.filter(matchAllCadastro);
  
  // Resetar para primeira página se necessário
  const totalPaginas = Math.ceil(dadosFiltrados.length / ITENS_POR_PAGINA);
  if (paginaAtual > totalPaginas && totalPaginas > 0) {
    paginaAtual = 1;
  }
  
  const dadosPagina = getDadosPagina();
  
  tblHead.innerHTML = '<tr><th>Empresa</th><th>CNPJ</th><th>IE</th><th>Federal</th><th>Estadual</th><th>Municipal</th><th>FGTS</th><th style="width:80px">Ações</th></tr>';
  
  if (dadosPagina.length === 0) {
    tblBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: var(--muted);">Nenhum registro encontrado</td></tr>';
    // Remover paginação se não há dados
    const existingPagination = $('.paginacao');
    if (existingPagination) existingPagination.remove();
    return;
  }
  
  const rows = dadosPagina.map(e => {
    const key = keyOf(e);
    
    return `<tr>
      <td class="empresa-cell">
        <span class="empresa-name">${e.empresa}</span>
        <div class="sub">
          <div class="local-info">${e.municipio}/${e.uf}</div>
          <div class="ie-info">IE: ${e.inscricao_estadual || '—'}</div>
        </div>
      </td>
      <td class="cnpj-cell">${fmtCNPJ(e.cnpj)}</td>
      <td>${e.inscricao_estadual || '—'}</td>
      <td>${statusBadge(rowStatus(key, 'federal'))}</td>
      <td>${statusBadge(rowStatus(key, 'estadual'))}</td>
      <td>${statusBadge(rowStatus(key, 'municipal'))}</td>
      <td>${statusBadge(rowStatus(key, 'fgts'))}</td>
      <td class="row-actions">
        <button data-key="${key}" class="btnEditar btn-ghost btn-icon" title="Editar CND">✏️</button>
        <button data-key="${key}" class="btnEditEmp btn-ghost btn-icon" title="Editar Cadastro">📝</button>
      </td>
    </tr>`;
  }).join('');
  
  tblBody.innerHTML = rows;
  
  // Adicionar eventos aos botões
  $$('.btnEditar').forEach(b => {
    b.addEventListener('click', () => openModalCND(b.dataset.key));
  });
  
  $$('.btnEditEmp').forEach(b => {
    b.addEventListener('click', () => openModalEmpresa(b.dataset.key));
  });
  
  // Renderizar paginação
  renderPaginacao();
}

function renderAll() {
  renderKPIs();
  renderTable();
  if ($('#view-dashboard').style.display === 'block') {
    renderCharts();
  }
}

// ===== Exportação =====
function exportCSV() {
  const rows = [['Empresa', 'CNPJ', 'Município', 'UF', 'IE', 'Federal', 'Estadual', 'Municipal', 'FGTS']];
  
  state.empresas.forEach(e => {
    const key = keyOf(e);
    rows.push([
      e.empresa,
      fmtCNPJ(e.cnpj),
      e.municipio,
      e.uf,
      e.inscricao_estadual || '',
      rowStatus(key, 'federal'),
      rowStatus(key, 'estadual'),
      rowStatus(key, 'municipal'),
      rowStatus(key, 'fgts')
    ]);
  });
  
  const csv = rows.map(r => r.map(v => `"${String(v).replace('"', '""')}"`).join(';')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'cnds_export.csv';
  a.click();
  URL.revokeObjectURL(url);
  showToast('CSV exportado com sucesso');
}

function exportXLS() {
  let html = '<table><tr><th>Empresa</th><th>CNPJ</th><th>Município</th><th>UF</th><th>IE</th><th>Federal</th><th>Estadual</th><th>Municipal</th><th>FGTS</th></tr>';
  
  state.empresas.forEach(e => {
    const key = keyOf(e);
    html += `<tr>
      <td>${e.empresa}</td>
      <td>${fmtCNPJ(e.cnpj)}</td>
      <td>${e.municipio}</td>
      <td>${e.uf}</td>
      <td>${e.inscricao_estadual || ''}</td>
      <td>${rowStatus(key, 'federal')}</td>
      <td>${rowStatus(key, 'estadual')}</td>
      <td>${rowStatus(key, 'municipal')}</td>
      <td>${rowStatus(key, 'fgts')}</td>
    </tr>`;
  });
  
  html += '</table>';
  
  const blob = new Blob([`\uFEFF<html><head><meta charset="utf-8"/></head><body>${html}</body></html>`], { type: 'application/vnd.ms-excel' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'cnds_export.xls';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Excel exportado com sucesso');
}

// ===== Backup automático =====
let backupHandle = null;

async function pickBackupFile() {
  try {
    if (!window.showSaveFilePicker) {
      alert('Seu navegador não oferece File System Access API. Use o botão de backup JSON tradicional.');
      return;
    }
    
    backupHandle = await window.showSaveFilePicker({
      suggestedName: 'cnds_backup.json',
      types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }]
    });
    
    const writable = await backupHandle.createWritable();
    await writable.write(JSON.stringify(state, null, 2));
    await writable.close();
    
    showToast('Backup automático ativado');
  } catch(e) {
    console.warn(e);
  }
}

async function autoSave() {
  try {
    if (!backupHandle) return;
    const writable = await backupHandle.createWritable();
    await writable.write(JSON.stringify(state, null, 2));
    await writable.close();
  } catch(e) {
    console.warn('Falha no backup automático:', e.message);
  }
}

// ===== Dashboard =====
function drawBar(ctx, labels, values, colors) {
  const dpr = window.devicePixelRatio || 1;
  const rect = ctx.canvas.getBoundingClientRect();
  
  ctx.canvas.width = rect.width * dpr;
  ctx.canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  
  const padding = 40;
  const chartWidth = rect.width - padding * 2;
  const chartHeight = rect.height - padding * 2;
  
  const maxValue = Math.max(...values, 1);
  const barWidth = Math.max(20, chartWidth / labels.length * 0.7);
  const barHeightRatio = chartHeight / maxValue;
  
  ctx.clearRect(0, 0, rect.width, rect.height);
  
  // Desenhar barras
  labels.forEach((label, i) => {
    const barHeight = values[i] * barHeightRatio;
    const x = padding + i * (chartWidth / labels.length) + (chartWidth / labels.length - barWidth) / 2;
    const y = padding + chartHeight - barHeight;
    
    ctx.fillStyle = colors[i % colors.length];
    ctx.fillRect(x, y, barWidth, barHeight);
    
    // Valor
    ctx.fillStyle = '#0F172A';
    ctx.font = '12px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText(values[i], x + barWidth / 2, y - 5);
    
    // Rótulo
    ctx.fillText(label, x + barWidth / 2, padding + chartHeight + 15);
  });
}

// CORREÇÃO: Função computeStatusCounts corrigida para separar ATENÇÃO e NÃO VERIFICADA
function computeStatusCounts() {
  const counts = { reg: 0, irr: 0, ate: 0, nao: 0 };
  
  state.empresas.forEach(e => {
    const key = keyOf(e);
    GROUPS.forEach(g => {
      const status = rowStatus(key, g);
      if (status === 'REGULAR') counts.reg++;
      else if (status === 'IRREGULAR') counts.irr++;
      else if (status === 'OBS') counts.ate++; // ATENÇÃO
      else if (status === 'NÃO VERIFICADA') counts.nao++; // NÃO VERIFICADA
    });
  });
  
  return counts;
}

function computeUFCounts() {
  const map = {};
  
  state.empresas.forEach(e => {
    if (e.uf) {
      map[e.uf] = (map[e.uf] || 0) + 1;
    }
  });
  
  const pairs = Object.entries(map).sort((a, b) => b[1] - a[1]).slice(0, 12);
  return { labels: pairs.map(p => p[0]), values: pairs.map(p => p[1]) };
}

function renderCharts() {
  const st = computeStatusCounts();
  const labels = ['REGULAR', 'IRREGULAR', 'ATENÇÃO', 'NÃO VERIF.'];
  const values = [st.reg, st.irr, st.ate, st.nao];
  const colors = ['#059669', '#DC2626', '#FF6B00', '#94A3B8'];
  
  const statusCtx = $('#chartStatus').getContext('2d');
  drawBar(statusCtx, labels, values, colors);
  
  const uf = computeUFCounts();
  const ufCtx = $('#chartUF').getContext('2d');
  drawBar(ufCtx, uf.labels, uf.values, Array(uf.labels.length).fill('#0033A0'));
}

// ===== FEEDBACK VISUAL =====
function showProgress() {
  const progress = $('#progress');
  progress.style.display = 'block';
  return () => {
    progress.style.display = 'none';
  };
}

// ===== CORREÇÃO: Inicialização dos Event Listeners =====
function initializeEventListeners() {
  console.log('Inicializando event listeners...');
  
  // CORREÇÃO: Garantir que todos os botões tenham event listeners
  document.getElementById('btnNovo').addEventListener('click', () => {
    console.log('Botão Novo clicado');
    openModalEmpresa(null);
  });
  
  document.getElementById('btnExportCSV').addEventListener('click', () => {
    console.log('Botão CSV clicado');
    exportCSV();
  });
  
  document.getElementById('btnExportXLS').addEventListener('click', () => {
    console.log('Botão Excel clicado');
    exportXLS();
  });
  
  document.getElementById('btnExport').addEventListener('click', () => {
    console.log('Botão Backup clicado');
    const data = JSON.stringify(state, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cnds_backup.json';
    a.click();
    URL.revokeObjectURL(url);
    showToast('Backup exportado com sucesso');
  });
  
  document.getElementById('btnAutoBackup').addEventListener('click', () => {
    console.log('Botão Auto Backup clicado');
    pickBackupFile();
  });
  
  document.getElementById('btnImport').addEventListener('click', () => {
    console.log('Botão Importar clicado');
    document.getElementById('importFile').click();
  });

  // CORREÇÃO: Botão recuperar com sistema seguro
  document.getElementById('btnRescue').addEventListener('click', () => {
    console.log('Botão Recuperar clicado');
    showRestoreOptions();
  });

  // CORREÇÃO: Botão limpar cache
  document.getElementById('btnLimparStorage').addEventListener('click', () => {
    if (confirm('ISSO REMOVERÁ TODOS OS BACKUPS ANTIGOS (exceto dados atuais). Continuar?')) {
      const removidos = limparBackupsAntigos();
      const espaco = verificarEspacoStorage();
      showToast(`${removidos} backups antigos removidos. Espaço: ${espaco?.totalMB}MB`);
    }
  });

  document.getElementById('importFile').addEventListener('change', (ev) => {
    const file = ev.target.files[0];
    if (!file) return;
    
    const hideProgress = showProgress();
    
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const obj = JSON.parse(reader.result);
        if (!obj.empresas || !obj.cnds) throw new Error('Estrutura inválida');
        
        state = migrateIfNeeded(obj);
        save(STORAGE_MASTER_KEY, state);
        renderAll();
        refreshEmpresaFilter();
        showToast('Backup carregado com sucesso');
      } catch(e) {
        alert('Arquivo inválido: ' + e.message);
      } finally {
        hideProgress();
      }
    };
    reader.readAsText(file);
  });

  // Filtros
  q.addEventListener('input', () => {
    paginaAtual = 1;
    renderAll();
  });
  
  ufFilter.addEventListener('change', () => {
    paginaAtual = 1;
    renderAll();
  });
  
  empresaFilter.addEventListener('change', () => {
    paginaAtual = 1;
    renderAll();
  });
  
  tipoCND.addEventListener('change', () => {
    paginaAtual = 1;
    renderAll();
  });
  
  statusFilter.addEventListener('change', () => {
    quick = null;
    paginaAtual = 1;
    renderAll();
  });
  
  modeSel.addEventListener('change', () => {
    paginaAtual = 1;
    renderAll();
  });

  document.getElementById('btnLimpar').addEventListener('click', () => {
    q.value = '';
    ufFilter.value = '';
    empresaFilter.value = '';
    tipoCND.value = '';
    statusFilter.value = '';
    quick = null;
    paginaAtual = 1;
    renderAll();
  });

  // Mobile menu
  document.getElementById('btnMobileMenu').addEventListener('click', () => {
    document.getElementById('mobileMenuContent').classList.toggle('show');
  });

  // Mobile buttons
  document.getElementById('btnNovoMobile').addEventListener('click', () => openModalEmpresa(null));
  document.getElementById('btnExportXLSMobile').addEventListener('click', exportXLS);
  document.getElementById('btnExportCSVMobile').addEventListener('click', exportCSV);
  document.getElementById('btnExportMobile').addEventListener('click', () => document.getElementById('btnExport').click());
  document.getElementById('btnAutoBackupMobile').addEventListener('click', pickBackupFile);
  document.getElementById('btnImportMobile').addEventListener('click', () => document.getElementById('importFile').click());

  // CORREÇÃO: Botão recuperar mobile com sistema seguro
  document.getElementById('btnRescueMobile').addEventListener('click', showRestoreOptions);

  // CORREÇÃO: Botão limpar cache mobile
  document.getElementById('btnLimparStorageMobile').addEventListener('click', () => {
    document.getElementById('btnLimparStorage').click();
  });

  console.log('Event listeners inicializados com sucesso!');
}

// Inicialização
console.log('Iniciando renderização...');
initializeEventListeners();
renderAll();

// Formatação automática do CNPJ
document.getElementById('me_cnpj').addEventListener('input', function(e) {
  let value = onlyDigits(e.target.value);
  if (value.length > 14) value = value.slice(0, 14);
  e.target.value = fmtCNPJ(value);
});

console.log('Sistema CND inicializado com sucesso!');
  </script>
</body>
</html>
