<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Acompanhamento de CNDs</title>
<style>
:root {
  --bg: #F8FAFC;
  --card: #FFFFFF;
  --line: #E2E8F0;
  --muted: #64748B;
  --text: #0F172A;
  --ok: #059669;
  --warn: #D97706;
  --bad: #DC2626;
  --na: #94A3B8;
  --eletro-blue: #0033A0;
  --eletro-yellow: #FFB81C;
  --eletro-orange: #FF6B00;
  --shadow: 0 2px 8px -1px rgba(0, 0, 0, 0.06), 0 1px 4px -1px rgba(0, 0, 0, 0.04);
  --radius: 6px;
  --transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
  --gradient: linear-gradient(135deg, #0033A0, #0066CC);
  --gradient-light: linear-gradient(135deg, #0047BB, #0088FF);
  --gradient-card: linear-gradient(135deg, #FFFFFF, #F8FAFC);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  height: 100%;
  /* Patroniza√ß√£o de fontes */
  font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
}

body {
  background: var(--bg);
  color: var(--text);
  font-size: 13px;
  line-height: 1.3;
}

/* Header mais compacto */
header {
  background: var(--gradient);
  color: white;
  padding: 10px 14px;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 1px 8px rgba(0, 51, 160, 0.15);
  position: sticky;
  top: 0;
  z-index: 100;
}

.logo {
  width: 28px;
  height: 28px;
  border-radius: 5px;
  background: var(--eletro-yellow);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--eletro-blue);
  font-weight: bold;
  font-size: 12px;
  box-shadow: 0 1px 6px rgba(255, 184, 28, 0.25);
}

.title {
  font-size: 15px;
  font-weight: 700;
  letter-spacing: -0.01em;
}

/* Main content mais compacto */
main {
  padding: 14px;
  max-width: 1400px;
  margin: 0 auto;
  width: 100%;
}

/* Tabs mais compactas */
nav.tabs {
  background: white;
  border-radius: var(--radius);
  padding: 3px;
  display: inline-flex;
  gap: 1px;
  margin-bottom: 14px;
  box-shadow: var(--shadow);
  border: 1px solid var(--line);
  transition: var(--transition);
}

.tabs button {
  background: transparent;
  border: none;
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
  font-weight: 600;
  color: var(--muted);
  transition: var(--transition);
  position: relative;
  overflow: hidden;
  font-size: 11px;
}

.tabs button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: var(--gradient-light);
  transition: var(--transition);
  z-index: -1;
}

.tabs button:hover {
  color: var(--eletro-blue);
  transform: translateY(-1px);
}

.tabs button:hover::before {
  left: 0;
  opacity: 0.1;
}

.tabs button.active {
  background: var(--gradient);
  color: white;
  box-shadow: 0 1px 6px rgba(0, 51, 160, 0.15);
  transform: translateY(0);
}

/* KPIs mais compactos */
.kpis {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  margin: 14px 0;
}

.card {
  background: var(--gradient-card);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  padding: 14px;
  box-shadow: var(--shadow);
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--gradient);
  opacity: 0;
  transition: var(--transition);
  z-index: 0;
}

.card:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
}

.card:hover::before {
  opacity: 0.03;
}

.card h4 {
  margin: 0 0 6px;
  color: var(--muted);
  font-weight: 600;
  font-size: 11px;
  display: flex;
  align-items: center;
  gap: 5px;
  position: relative;
  z-index: 1;
}

.card .v {
  font-size: 20px;
  font-weight: 800;
  color: var(--eletro-blue);
  position: relative;
  z-index: 1;
}

.card.kpi {
  cursor: pointer;
}

.card.kpi.active {
  box-shadow: 0 0 0 2px rgba(0, 51, 160, 0.15);
  border-color: var(--eletro-blue);
}

/* Cards com cores espec√≠ficas */
.card.kpi.total { border-left: 2px solid var(--eletro-blue); }
.card.kpi.regular { border-left: 2px solid var(--ok); }
.card.kpi.irregular { border-left: 2px solid var(--bad); }
.card.kpi.atencao { border-left: 2px solid var(--eletro-orange); }

/* Controls mais compactos */
.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin: 14px 0;
  align-items: center;
  padding: 14px;
  background: white;
  border-radius: var(--radius);
  border: 1px solid var(--line);
  box-shadow: var(--shadow);
  transition: var(--transition);
}

.controls:hover {
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
}

.controls .sep {
  height: 18px;
  border-left: 1px solid var(--line);
}

input[type="search"], select, button {
  background: white;
  border: 1px solid var(--line);
  border-radius: 5px;
  padding: 6px 10px;
  font-size: 11px;
  transition: var(--transition);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
  font-family: inherit;
}

input[type="search"]:focus, select:focus {
  outline: none;
  border-color: var(--eletro-blue);
  box-shadow: 0 0 0 2px rgba(0, 51, 160, 0.08);
}

button {
  cursor: pointer;
  font-weight: 600;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
  font-size: 11px;
  font-family: inherit;
}

button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: var(--gradient);
  transition: var(--transition);
  z-index: -1;
  opacity: 0;
}

button:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
}

button:hover::before {
  left: 0;
  opacity: 0.1;
}

.btn-primary {
  background: var(--gradient);
  color: white;
  border: none;
  box-shadow: 0 1px 4px rgba(0, 51, 160, 0.15);
}

.btn-primary:hover {
  background: var(--gradient-light);
  box-shadow: 0 2px 6px rgba(0, 51, 160, 0.2);
}

.btn-ghost {
  background: white;
  color: var(--text);
  border: 1px solid var(--line);
}

.btn-ghost:hover {
  background: #F8FAFC;
  border-color: var(--eletro-blue);
  color: var(--eletro-blue);
}

/* Badges mais compactas */
.badge {
  padding: 3px 6px;
  border-radius: 12px;
  font-size: 9px;
  font-weight: 600;
  display: inline-flex;
  gap: 3px;
  align-items: center;
  white-space: nowrap;
  transition: var(--transition);
  line-height: 1;
}

.badge:hover {
  transform: scale(1.02);
}

.badge.regular {
  background: rgba(5, 150, 105, 0.1);
  color: #065F46;
  border: 1px solid rgba(5, 150, 105, 0.3);
}

.badge.irregular {
  background: rgba(220, 38, 38, 0.1);
  color: #7F1D1D;
  border: 1px solid rgba(220, 38, 38, 0.3);
}

.badge.atencao {
  background: rgba(255, 107, 0, 0.1);
  color: #7C2D12;
  border: 1px solid rgba(255, 107, 0, 0.3);
}

.badge.nao-verificada {
  background: rgba(148, 163, 184, 0.1);
  color: #374151;
  border: 1px solid rgba(148, 163, 184, 0.3);
}

/* Table mais compacta - MELHORIA PRINCIPAL */
.table-container {
  background: white;
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow);
  border: 1px solid var(--line);
  transition: var(--transition);
}

.table-container:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  font-size: 11px;
}

.table thead {
  background: #F8FAFC;
}

.table th {
  padding: 10px 8px;
  text-align: left;
  font-weight: 600;
  color: var(--muted);
  border-bottom: 1px solid var(--line);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.2px;
}

.table td {
  padding: 8px;
  border-bottom: 1px solid var(--line);
  transition: var(--transition);
  vertical-align: middle;
}

.table tbody tr {
  transition: var(--transition);
}

.table tbody tr:hover {
  transform: translateY(-1px);
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.02);
}

.table tbody tr:hover td {
  background: #F8FAFC;
}

.row-actions {
  display: flex;
  gap: 4px;
  flex-wrap: nowrap;
}

.sub {
  color: var(--muted);
  font-size: 9px;
  margin-top: 1px;
  line-height: 1.2;
}

/* Melhorias espec√≠ficas para CNPJ - SEM QUEBRA DE LINHA */
.cnpj-cell {
  white-space: nowrap;
  font-family: 'SF Mono', 'Monaco', 'Consolas', 'Roboto Mono', monospace;
  font-size: 10px;
}

.empresa-cell {
  max-width: 160px;
  min-width: 130px;
}

.empresa-name {
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  display: block;
  font-size: 11px;
}

.local-info {
  display: flex;
  align-items: center;
  gap: 3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: 9px;
}

.ie-info {
  display: flex;
  align-items: center;
  gap: 3px;
  white-space: nowrap;
  font-size: 9px;
}

/* Bot√µes de a√ß√£o compactos com √≠cones */
.btn-icon {
  width: 24px;
  height: 24px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  font-size: 11px;
}

.btn-icon-text {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 6px;
  font-size: 10px;
}

/* Modal mais compacto */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 14px;
  z-index: 1000;
  animation: fadeIn 0.3s ease-out;
}

.modal .box {
  width: min(900px, 95%);
  background: white;
  border-radius: var(--radius);
  padding: 18px;
  box-shadow: 0 8px 24px -6px rgba(0, 0, 0, 0.15);
  border: 1px solid var(--line);
  animation: modalSlideIn 0.3s ease-out;
  max-height: 90vh;
  overflow-y: auto;
}

.modal h3 {
  margin: 0 0 14px;
  font-size: 18px;
  font-weight: 700;
  background: var(--gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.grid-2, .grid-4 {
  display: grid;
  gap: 10px;
}

.grid-2 { grid-template-columns: 1fr 1fr; }
.grid-4 { grid-template-columns: repeat(4, 1fr); }

.field {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

label {
  color: var(--muted);
  font-weight: 600;
  font-size: 11px;
}

hr.sep {
  border: none;
  border-top: 1px solid var(--line);
  margin: 14px 0;
}

.footer {
  margin-top: 14px;
  color: var(--muted);
  font-size: 9px;
  text-align: center;
  padding: 10px;
  background: #F8FAFC;
  border-radius: var(--radius);
}

/* Toast mais compacto */
.toast {
  position: fixed;
  right: 14px;
  bottom: 14px;
  background: white;
  color: var(--text);
  padding: 10px 14px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 1px solid var(--line);
  opacity: 0;
  transform: translateY(14px);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 6px;
  border-left: 2px solid var(--ok);
  font-size: 11px;
}

.toast.show {
  opacity: 1;
  transform: translateY(0);
}

/* KPI dots */
.kpi-dot {
  display: inline-block;
  width: 5px;
  height: 5px;
  border-radius: 50%;
}

.dot-regular { background: var(--ok); }
.dot-atencao { background: var(--eletro-orange); }
.dot-irregular { background: var(--bad); }

/* Charts mais compactos */
.chart {
  background: white;
  border: 1px solid var(--line);
  border-radius: var(--radius);
  padding: 14px;
  box-shadow: var(--shadow);
  transition: var(--transition);
}

.chart:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.chart h5 {
  margin: 0 0 10px;
  color: var(--muted);
  font-weight: 600;
  font-size: 12px;
}

.canvas {
  width: 100%;
  height: 200px;
}

.grid-2c {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
}

/* Progress indicator */
.progress {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 2px;
  background: var(--gradient);
  z-index: 2000;
  animation: progress 2s infinite;
}

/* Mobile menu */
.mobile-menu {
  display: none;
  position: relative;
}

.mobile-menu-content {
  display: none;
  position: absolute;
  top: 100%;
  right: 0;
  background: white;
  border: 1px solid var(--line);
  border-radius: var(--radius);
  padding: 6px;
  box-shadow: var(--shadow);
  z-index: 25;
  min-width: 140px;
  animation: fadeInUp 0.3s ease;
}

.mobile-menu-content.show {
  display: block;
}

.mobile-menu-content button {
  width: 100%;
  margin-bottom: 1px;
  text-align: left;
  font-size: 10px;
  padding: 5px 6px;
}

/* Status com validade */
.status-with-date {
  display: flex;
  flex-direction: column;
  gap: 1px;
}

.expiry-date {
  font-size: 8px;
  color: var(--muted);
  font-weight: 500;
}

.expiry-date.expired {
  color: var(--bad);
  font-weight: 600;
}

.expiry-date.warning {
  color: var(--eletro-orange);
  font-weight: 600;
}

.expiry-date.valid {
  color: var(--ok);
  font-weight: 600;
}

.expiry-date.today {
  color: var(--eletro-blue);
  font-weight: 600;
}

/* Anima√ß√µes */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(14px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-14px) scale(0.98);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

@keyframes progress {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* Responsive */
@media (max-width: 1200px) {
  .grid-4 {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 1024px) {
  .kpis {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .grid-2c {
    grid-template-columns: 1fr;
  }
  
  header .row-actions {
    display: none;
  }
  
  .mobile-menu {
    display: block;
  }
}

@media (max-width: 768px) {
  main {
    padding: 10px;
  }
  
  .grid-2, .grid-4 {
    grid-template-columns: 1fr;
  }
  
  .table-container {
    overflow-x: auto;
  }
  
  .controls {
    flex-direction: column;
    align-items: stretch;
  }
  
  .controls .sep {
    display: none;
  }
  
  .row-actions {
    flex-direction: column;
  }
  
  .kpis {
    grid-template-columns: 1fr;
  }
  
  /* Ajustes espec√≠ficos para mobile na tabela */
  .table th, .table td {
    padding: 6px 4px;
  }
  
  .empresa-cell {
    max-width: 120px;
    min-width: 100px;
  }
  
  .btn-icon-text span {
    display: none;
  }
  
  .btn-icon-text {
    width: 24px;
    padding: 0;
    justify-content: center;
  }
}

/* Bot√µes com √≠cones */
.btn-with-icon {
  display: flex;
  align-items: center;
  gap: 4px;
}
</style>
</head>
<body>
  <div class="progress" id="progress"></div>
  
  <header>
    <div class="logo">CND</div>
    <div class="title">Acompanhamento de CNDs</div>
    <div style="margin-left:auto" class="row-actions">
      <button id="btnNovo" class="btn-primary btn-with-icon">
        <span>+</span> Novo
      </button>
      <button id="btnExportXLS" class="btn-ghost">Excel</button>
      <button id="btnExportCSV" class="btn-ghost">CSV</button>
      <button id="btnExport" class="btn-ghost">Backup</button>
      <button id="btnAutoBackup" class="btn-ghost">Auto Backup</button>
      <button id="btnImport" class="btn-ghost">Importar</button>
      <button id="btnRescue" class="btn-ghost">Recuperar</button>
      <input id="importFile" type="file" accept="application/json" hidden />
    </div>
    
    <!-- Mobile menu -->
    <div class="mobile-menu">
      <button id="btnMobileMenu" class="btn-ghost">‚ò∞</button>
      <div class="mobile-menu-content" id="mobileMenuContent">
        <button id="btnNovoMobile" class="btn-ghost">+ Novo</button>
        <button id="btnExportXLSMobile" class="btn-ghost">Excel</button>
        <button id="btnExportCSVMobile" class="btn-ghost">CSV</button>
        <button id="btnExportMobile" class="btn-ghost">Backup</button>
        <button id="btnAutoBackupMobile" class="btn-ghost">Auto Backup</button>
        <button id="btnImportMobile" class="btn-ghost">Importar</button>
        <button id="btnRescueMobile" class="btn-ghost">Recuperar</button>
      </div>
    </div>
  </header>
  
  <main>
    <nav class="tabs">
      <button class="active" data-tab="lista">
        <span>üìã</span> Lista
      </button>
      <button data-tab="dashboard">
        <span>üìä</span> Dashboard
      </button>
    </nav>

    <section class="kpis" id="kpis"></section>

    <div class="controls" id="controls">
      <select id="empresaFilter"><option value="">Empresa (todas)</option></select>
      <select id="ufFilter"><option value="">UF (todas)</option></select>
      <select id="tipoCND"><option value="">Tipo de CND (todas)</option><option value="federal">Federal</option><option value="estadual">Estadual</option><option value="municipal">Municipal</option><option value="fgts">FGTS</option></select>
      <select id="statusFilter"><option value="">Status (todos)</option><option value="REGULAR">REGULAR</option><option value="IRREGULAR">IRREGULAR</option><option value="ATENCAO">ATEN√á√ÉO</option><option value="NAO_VERIFICADA">N√ÉO VERIFICADA</option></select>
      <span class="sep"></span>
      <label style="color:var(--muted);font-weight:600">Modo:</label>
      <select id="mode"><option value="CADASTRO">Cadastros</option><option value="CNPJ">CNPJ</option></select>
      <button id="btnLimpar" class="btn-ghost">Limpar</button>
      <input type="search" id="q" placeholder="Buscar‚Ä¶"/>
    </div>

    <section id="view-lista">
      <div class="table-container">
        <table class="table" id="tbl">
          <thead id="thead"></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="footer">
        Sistema de acompanhamento de CNDs ‚Ä¢ Desenvolvido para gest√£o eficiente de certificados
      </div>
    </section>

    <section id="view-dashboard" style="display:none">
      <div class="grid-2c">
        <div class="chart">
          <h5>üìà Distribui√ß√£o por Status</h5>
          <canvas id="chartStatus" class="canvas"></canvas>
        </div>
        <div class="chart">
          <h5>üó∫Ô∏è Cadastros por UF (Top 12)</h5>
          <canvas id="chartUF" class="canvas"></canvas>
        </div>
      </div>
      <div class="footer">
        Dashboard interativo ‚Ä¢ Dados atualizados em tempo real
      </div>
    </section>
  </main>

  <div class="toast" id="toast">Altera√ß√µes salvas com sucesso</div>

  <!-- Modal para cadastro/edi√ß√£o de empresa -->
  <div class="modal" id="modalEmpresa">
    <div class="box">
      <h3 id="modalEmpresaTitle">Novo Cadastro</h3>
      <div class="grid-2">
        <div class="field">
          <label>Empresa *</label>
          <input type="text" id="me_empresa" placeholder="Raz√£o social" required>
        </div>
        <div class="field">
          <label>CNPJ *</label>
          <input type="text" id="me_cnpj" placeholder="Somente n√∫meros" required>
        </div>
        <div class="field">
          <label>Munic√≠pio *</label>
          <input type="text" id="me_municipio" placeholder="Munic√≠pio" required>
        </div>
        <div class="field">
          <label>UF *</label>
          <select id="me_uf" required>
            <option value="">Selecione</option>
            <option value="AC">AC</option>
            <option value="AL">AL</option>
            <option value="AM">AM</option>
            <option value="AP">AP</option>
            <option value="BA">BA</option>
            <option value="CE">CE</option>
            <option value="DF">DF</option>
            <option value="ES">ES</option>
            <option value="GO">GO</option>
            <option value="MA">MA</option>
            <option value="MG">MG</option>
            <option value="MS">MS</option>
            <option value="MT">MT</option>
            <option value="PA">PA</option>
            <option value="PB">PB</option>
            <option value="PE">PE</option>
            <option value="PI">PI</option>
            <option value="PR">PR</option>
            <option value="RJ">RJ</option>
            <option value="RN">RN</option>
            <option value="RO">RO</option>
            <option value="RR">RR</option>
            <option value="RS">RS</option>
            <option value="SC">SC</option>
            <option value="SE">SE</option>
            <option value="SP">SP</option>
            <option value="TO">TO</option>
          </select>
        </div>
      </div>
      <div class="field">
        <label>Inscri√ß√£o Estadual</label>
        <input type="text" id="me_ie" placeholder="Inscri√ß√£o Estadual">
      </div>
      <hr class="sep">
      <div style="display: flex; gap: 6px; justify-content: flex-end">
        <button id="me_cancel" class="btn-ghost">Cancelar</button>
        <button id="me_save" class="btn-primary">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal para edi√ß√£o de CND -->
  <div class="modal" id="modalCND">
    <div class="box">
      <h3>Atualizar CND ‚Äî <span id="mEmpresa"></span></h3>
      <div class="grid-4">
        <div class="field">
          <label>FEDERAL ‚Äî Status</label>
          <select id="federal_status">
            <option value="REGULAR">REGULAR</option>
            <option value="IRREGULAR">IRREGULAR</option>
            <option value="OBS">ATEN√á√ÉO</option>
            <option value="N√ÉO VERIFICADA">N√ÉO VERIFICADA</option>
          </select>
          <label>Validade</label>
          <input id="federal_validade" type="date">
          <div id="federal_update_info" class="expiry-date today" style="display:none">Atualizado hoje</div>
          <label>Link da certid√£o</label>
          <input id="federal_link" type="url" placeholder="https://‚Ä¶">
          <label>Observa√ß√µes</label>
          <input id="federal_obs" placeholder="Observa√ß√µes">
        </div>
        <div class="field">
          <label>ESTADUAL ‚Äî Status</label>
          <select id="estadual_status">
            <option value="REGULAR">REGULAR</option>
            <option value="IRREGULAR">IRREGULAR</option>
            <option value="OBS">ATEN√á√ÉO</option>
            <option value="N√ÉO VERIFICADA">N√ÉO VERIFICADA</option>
          </select>
          <label>Validade</label>
          <input id="estadual_validade" type="date">
          <div id="estadual_update_info" class="expiry-date today" style="display:none">Atualizado hoje</div>
          <label>Link da certid√£o</label>
          <input id="estadual_link" type="url" placeholder="https://‚Ä¶">
          <label>Observa√ß√µes</label>
          <input id="estadual_obs" placeholder="Observa√ß√µes">
        </div>
        <div class="field">
          <label>MUNICIPAL ‚Äî Status</label>
          <select id="municipal_status">
            <option value="REGULAR">REGULAR</option>
            <option value="IRREGULAR">IRREGULAR</option>
            <option value="OBS">ATEN√á√ÉO</option>
            <option value="N√ÉO VERIFICADA">N√ÉO VERIFICADA</option>
          </select>
          <label>Validade</label>
          <input id="municipal_validade" type="date">
          <div id="municipal_update_info" class="expiry-date today" style="display:none">Atualizado hoje</div>
          <label>Link da certid√£o</label>
          <input id="municipal_link" type="url" placeholder="https://‚Ä¶">
          <label>Observa√ß√µes</label>
          <input id="municipal_obs" placeholder="Observa√ß√µes">
        </div>
        <div class="field">
          <label>FGTS ‚Äî Status</label>
          <select id="fgts_status">
            <option value="REGULAR">REGULAR</option>
            <option value="IRREGULAR">IRREGULAR</option>
            <option value="OBS">ATEN√á√ÉO</option>
            <option value="N√ÉO VERIFICADA">N√ÉO VERIFICADA</option>
          </select>
          <label>Validade</label>
          <input id="fgts_validade" type="date">
          <div id="fgts_update_info" class="expiry-date today" style="display:none">Atualizado hoje</div>
          <label>Link da certid√£o</label>
          <input id="fgts_link" type="url" placeholder="https://‚Ä¶">
          <label>Observa√ß√µes</label>
          <input id="fgts_obs" placeholder="Observa√ß√µes">
        </div>
      </div>
      <hr class="sep">
      <div class="row-actions" style="justify-content: space-between">
        <div class="row-actions">
          <button id="btnEditarEmpresa" class="btn-ghost btn-icon-text">‚úèÔ∏è <span>Editar</span></button>
          <button id="btnExcluirEmpresa" class="btn-ghost btn-icon-text" style="color:#DC2626">üóëÔ∏è <span>Excluir</span></button>
        </div>
        <div class="row-actions">
          <button id="btnFechar" class="btn-ghost">Cancelar</button>
          <button id="btnSalvar" class="btn-primary">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
// ===== Constantes & helpers =====
const STATUSES = ['REGULAR','IRREGULAR','OBS','N√ÉO VERIFICADA'];
const GROUPS = ['federal','estadual','municipal','fgts'];
const STORAGE_MASTER_KEY = 'cnds_data';
const LEGACY_KEYS = ['cnds_data_v3_2','cnds_data_v3_1','cnds_data_v3','cnds_data_v2'];
const ALL_UF = ['AC','AL','AM','AP','BA','CE','DF','ES','GO','MA','MG','MS','MT','PA','PB','PE','PI','PR','RJ','RN','RO','RR','RS','SC','SE','SP','TO'];

// Seletores DOM
const $ = (sel, root = document) => root.querySelector(sel);
const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

// Utilit√°rios
const fmtCNPJ = c => c && c.length === 14 ? c.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5') : c;
const onlyDigits = s => String(s || '').replace(/\D/g, '');
const norm = s => String(s || '').trim().toUpperCase();
const uiStatus = s => s === 'OBS' ? 'ATEN√á√ÉO' : s;
const isAtencao = s => s === 'OBS' || s === 'N√ÉO VERIFICADA';
const keyOf = e => [e.cnpj, norm(e.uf), norm(e.municipio), norm(e.inscricao_estadual)].join('|');
const showToast = (msg) => { 
  const t = $('#toast'); 
  t.textContent = msg || 'Altera√ß√µes salvas'; 
  t.classList.add('show'); 
  setTimeout(() => t.classList.remove('show'), 3000); 
};

// Fun√ß√£o para obter data atual no formato YYYY-MM-DD
const getToday = () => {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

// ===== Estado & recupera√ß√£o =====
function load(key) { 
  try { 
    return JSON.parse(localStorage.getItem(key) || 'null'); 
  } catch(e) { 
    return null; 
  } 
}

function save(key, value) { 
  localStorage.setItem(key, JSON.stringify(value)); 
  if (key === STORAGE_MASTER_KEY) {
    autoSave();
  }
}

function seedFromEmbed() { 
  const empresas = [
    {
      empresa: "ELETROBRAS S.A.",
      cnpj: "00000000000191",
      municipio: "Rio de Janeiro",
      uf: "RJ",
      inscricao_estadual: "123456789"
    }
  ];
  
  const cnds = {};
  empresas.forEach(e => {
    cnds[keyOf(e)] = {
      federal: { status: 'N√ÉO VERIFICADA', validade: '', link: '', obs: '' },
      estadual: { status: 'N√ÉO VERIFICADA', validade: '', link: '', obs: '' },
      municipal: { status: 'N√ÉO VERIFICADA', validade: '', link: '', obs: '' },
      fgts: { status: 'N√ÉO VERIFICADA', validade: '', link: '', obs: '' }
    };
  });
  
  return { empresas, cnds, schemaVersion: 4 };
}

function migrateIfNeeded(state) {
  if (!state || !state.cnds || !state.empresas) return state;
  
  Object.keys(state.cnds).forEach(k => {
    GROUPS.forEach(g => {
      if (!state.cnds[k][g]) {
        state.cnds[k][g] = { status: 'N√ÉO VERIFICADA', validade: '', link: '', obs: '' };
      }
    });
  });
  
  state.schemaVersion = (state.schemaVersion || 3) + 1;
  return state;
}

function scanCandidates() {
  const found = [];
  if (localStorage.getItem(STORAGE_MASTER_KEY)) {
    found.push({ key: STORAGE_MASTER_KEY, label: 'Atual (cnds_data)' });
  }
  
  LEGACY_KEYS.forEach(k => {
    if (localStorage.getItem(k)) {
      found.push({ key: k, label: 'Antigo: ' + k });
    }
  });
  
  return found;
}

let state = load(STORAGE_MASTER_KEY);
if (!state) {
  const cands = scanCandidates();
  if (cands.length) {
    // Se h√° dados antigos, vamos carregar o primeiro dispon√≠vel
    const firstCandidate = cands[0];
    state = migrateIfNeeded(load(firstCandidate.key));
    save(STORAGE_MASTER_KEY, state);
    showToast('Dados recuperados de ' + firstCandidate.key);
  } else {
    state = seedFromEmbed();
    save(STORAGE_MASTER_KEY, state);
  }
} else {
  state = migrateIfNeeded(state);
  save(STORAGE_MASTER_KEY, state);
}

// ===== Tabs =====
const tabs = $$('.tabs button');
const viewLista = $('#view-lista');
const viewDash = $('#view-dashboard');

tabs.forEach(b => {
  b.addEventListener('click', () => {
    tabs.forEach(x => x.classList.remove('active'));
    b.classList.add('active');
    const tab = b.dataset.tab;
    if (tab === 'lista') {
      viewLista.style.display = 'block';
      viewDash.style.display = 'none';
    } else {
      viewLista.style.display = 'none';
      viewDash.style.display = 'block';
      renderCharts();
    }
  });
});

// ===== UI refs =====
const tblHead = $('#thead');
const tblBody = $('#tbl tbody');
const q = $('#q');
const empresaFilter = $('#empresaFilter');
const ufFilter = $('#ufFilter');
const tipoCND = $('#tipoCND');
const statusFilter = $('#statusFilter');
const modeSel = $('#mode');

// Popular UF filter
ufFilter.innerHTML += ALL_UF.map(u => `<option value="${u}">${u}</option>`).join('');

function refreshEmpresaFilter() {
  const sel = empresaFilter.value;
  const names = Array.from(new Set((state.empresas || []).map(e => e.empresa).filter(Boolean))).sort((a, b) => a.localeCompare(b, 'pt-BR'));
  empresaFilter.innerHTML = '<option value="">Empresa (todas)</option>' + names.map(n => `<option value="${n.replace(/\"/g, '&quot;')}">${n}</option>`).join('');
  if (names.includes(sel)) empresaFilter.value = sel;
}
refreshEmpresaFilter();

// ===== Modais CRUD =====
let editingKey = null;

function openModalEmpresa(key) {
  editingKey = key || null;
  const modal = $('#modalEmpresa');
  const title = $('#modalEmpresaTitle');
  
  title.textContent = editingKey ? 'Editar Cadastro' : 'Novo Cadastro';
  
  if (editingKey) {
    const e = state.empresas.find(x => keyOf(x) === editingKey);
    $('#me_empresa').value = e.empresa || '';
    $('#me_cnpj').value = e.cnpj || '';
    $('#me_municipio').value = e.municipio || '';
    $('#me_uf').value = e.uf || '';
    $('#me_ie').value = e.inscricao_estadual || '';
  } else {
    $('#me_empresa').value = '';
    $('#me_cnpj').value = '';
    $('#me_municipio').value = '';
    $('#me_uf').value = '';
    $('#me_ie').value = '';
  }
  
  modal.style.display = 'flex';
}

function closeModalEmpresa() {
  $('#modalEmpresa').style.display = 'none';
  editingKey = null;
}

$('#modalEmpresa').addEventListener('click', (ev) => {
  if (ev.target === $('#modalEmpresa')) closeModalEmpresa();
});

$('#me_cancel').addEventListener('click', closeModalEmpresa);

$('#me_save').addEventListener('click', () => {
  const empresa = $('#me_empresa').value.trim();
  const cnpj = onlyDigits($('#me_cnpj').value);
  const municipio = $('#me_municipio').value.trim();
  const uf = $('#me_uf').value;
  const ie = $('#me_ie').value.trim();
  
  if (!empresa) {
    alert('Informe a raz√£o social.');
    return;
  }
  if (!/^\d{14}$/.test(cnpj)) {
    alert('CNPJ inv√°lido (14 d√≠gitos).');
    return;
  }
  if (!uf) {
    alert('Selecione a UF.');
    return;
  }
  
  const novo = { empresa, cnpj, municipio, uf, inscricao_estadual: ie };
  const newKey = keyOf(novo);
  
  if (editingKey) {
    // Edi√ß√£o
    if (editingKey !== newKey) {
      // Chave mudou, verificar se j√° existe
      const existe = state.empresas.some(e => keyOf(e) === newKey);
      if (existe) {
        alert('J√° existe um cadastro com estes dados.');
        return;
      }
      
      // Remover antigo
      const idx = state.empresas.findIndex(x => keyOf(x) === editingKey);
      if (idx !== -1) {
        state.empresas.splice(idx, 1);
        delete state.cnds[editingKey];
      }
    }
  } else {
    // Novo cadastro - verificar se j√° existe
    const existe = state.empresas.some(e => keyOf(e) === newKey);
    if (existe) {
      alert('J√° existe um cadastro com estes dados.');
      return;
    }
  }
  
  state.empresas.push(novo);
  if (!state.cnds[newKey]) {
    state.cnds[newKey] = {
      federal: { status: 'N√ÉO VERIFICADA', validade: '', link: '', obs: '' },
      estadual: { status: 'N√ÉO VERIFICADA', validade: '', link: '', obs: '' },
      municipal: { status: 'N√ÉO VERIFICADA', validade: '', link: '', obs: '' },
      fgts: { status: 'N√ÉO VERIFICADA', validade: '', link: '', obs: '' }
    };
  }
  
  save(STORAGE_MASTER_KEY, state);
  renderAll();
  refreshEmpresaFilter();
  closeModalEmpresa();
  showToast(editingKey ? 'Cadastro atualizado' : 'Cadastro criado');
});

let currentKey = null;

function openModalCND(key) {
  currentKey = key;
  const e = state.empresas.find(x => keyOf(x) === key);
  const rec = state.cnds[key] || {
    federal: { status: 'N√ÉO VERIFICADA', validade: '', link: '', obs: '' },
    estadual: { status: 'N√ÉO VERIFICADA', validade: '', link: '', obs: '' },
    municipal: { status: 'N√ÉO VERIFICADA', validade: '', link: '', obs: '' },
    fgts: { status: 'N√ÉO VERIFICADA', validade: '', link: '', obs: '' }
  };
  
  $('#mEmpresa').textContent = `${e.empresa} ‚Äî ${fmtCNPJ(e.cnpj)}`;
  
  GROUPS.forEach(g => {
    const v = rec[g] || {};
    $(`#${g}_status`).value = v.status || 'N√ÉO VERIFICADA';
    $(`#${g}_validade`).value = v.validade || '';
    $(`#${g}_link`).value = v.link || '';
    $(`#${g}_obs`).value = v.obs || '';
    
    // Mostrar indicador se a validade foi atualizada hoje
    const updateInfo = $(`#${g}_update_info`);
    if (v.validade === getToday()) {
      updateInfo.style.display = 'block';
    } else {
      updateInfo.style.display = 'none';
    }
  });
  
  $('#modalCND').style.display = 'flex';
}

function closeModalCND() {
  $('#modalCND').style.display = 'none';
  currentKey = null;
}

$('#modalCND').addEventListener('click', (ev) => {
  if (ev.target === $('#modalCND')) closeModalCND();
});

$('#btnFechar').addEventListener('click', closeModalCND);

$('#btnSalvar').addEventListener('click', () => {
  if (!currentKey) return;
  
  GROUPS.forEach(g => {
    const currentStatus = $(`#${g}_status`).value;
    const currentValidade = $(`#${g}_validade`).value;
    
    // Se o status foi alterado, atualizar a validade para hoje
    const oldStatus = state.cnds[currentKey][g].status;
    let newValidade = currentValidade;
    
    if (currentStatus !== oldStatus) {
      newValidade = getToday();
      $(`#${g}_validade`).value = newValidade;
      $(`#${g}_update_info`).style.display = 'block';
    }
    
    state.cnds[currentKey][g] = {
      status: currentStatus,
      validade: newValidade,
      link: $(`#${g}_link`).value,
      obs: $(`#${g}_obs`).value,
      atualizadoEm: new Date().toISOString()
    };
  });
  
  save(STORAGE_MASTER_KEY, state);
  renderAll();
  closeModalCND();
  showToast('CNDs atualizadas');
});

$('#btnEditarEmpresa').addEventListener('click', () => {
  closeModalCND();
  openModalEmpresa(currentKey);
});

$('#btnExcluirEmpresa').addEventListener('click', () => {
  if (!currentKey) return;
  if (!confirm('Excluir este cadastro? Essa a√ß√£o n√£o pode ser desfeita.')) return;
  
  const idx = state.empresas.findIndex(x => keyOf(x) === currentKey);
  if (idx !== -1) state.empresas.splice(idx, 1);
  delete state.cnds[currentKey];
  
  save(STORAGE_MASTER_KEY, state);
  renderAll();
  closeModalCND();
  showToast('Cadastro exclu√≠do');
  refreshEmpresaFilter();
});

// ===== Filtros/KPIs/Tabela =====
let quick = null;

function rowStatus(key, g) {
  return (state.cnds[key] && state.cnds[key][g] && state.cnds[key][g].status) || 'N√ÉO VERIFICADA';
}

function matchAllCadastro(e) {
  const term = q.value.trim().toLowerCase();
  const key = keyOf(e);
  
  const okEmpresa = !empresaFilter.value || e.empresa === empresaFilter.value;
  const okTerm = !term || [e.cnpj, e.municipio, e.uf, e.inscricao_estadual].some(v => String(v || '').toLowerCase().includes(term));
  const okUF = !ufFilter.value || e.uf === ufFilter.value;
  
  const okStatus = (function() {
    const v = statusFilter.value;
    if (!v) return true;
    if (v === 'ATENCAO') {
      return GROUPS.some(g => isAtencao(rowStatus(key, g)));
    }
    if (v === 'NAO_VERIFICADA') {
      return GROUPS.some(g => rowStatus(key, g) === 'N√ÉO VERIFICADA');
    }
    return GROUPS.some(g => rowStatus(key, g) === v);
  })();
  
  return okEmpresa && okTerm && okUF && okStatus;
}

function computeOverview() {
  const filtered = state.empresas.filter(matchAllCadastro);
  const t = { total: filtered.length, regular: 0, irregular: 0, atencao: 0 };
  
  filtered.forEach(e => {
    const key = keyOf(e);
    const statuses = GROUPS.map(g => rowStatus(key, g));
    
    if (statuses.includes('REGULAR')) t.regular++;
    if (statuses.includes('IRREGULAR')) t.irregular++;
    if (statuses.some(s => isAtencao(s))) t.atencao++;
  });
  
  return t;
}

function statusBadge(s) {
  return `<span class="badge ${(s === 'REGULAR') ? 'regular' : (s === 'IRREGULAR') ? 'irregular' : (isAtencao(s) ? 'atencao' : 'nao-verificada')}">${uiStatus(s)}</span>`;
}

function renderKPIs() {
  const t = computeOverview();
  const k = $('#kpis');
  
  k.innerHTML = `
    <div class="card total"><h4>Total de Cadastros</h4><div class="v">${t.total}</div></div>
    <div class="card kpi regular ${quick === 'REGULAR' ? 'active' : ''}" id="kpi-regular"><h4><span class="kpi-dot dot-regular"></span> CNDs REGULAR</h4><div class="v">${t.regular}</div></div>
    <div class="card kpi irregular ${quick === 'IRREGULAR' ? 'active' : ''}" id="kpi-irregular"><h4><span class="kpi-dot dot-irregular"></span> CNDs IRREGULAR</h4><div class="v">${t.irregular}</div></div>
    <div class="card kpi atencao ${quick === 'ATENCAO' ? 'active' : ''}" id="kpi-atencao"><h4><span class="kpi-dot dot-atencao"></span> CNDs ATEN√á√ÉO</h4><div class="v">${t.atencao}</div></div>`;
    
  $('#kpi-regular').addEventListener('click', () => {
    quick = quick === 'REGULAR' ? null : 'REGULAR';
    statusFilter.value = quick === 'REGULAR' ? 'REGULAR' : '';
    renderAll();
  });
  
  $('#kpi-irregular').addEventListener('click', () => {
    quick = quick === 'IRREGULAR' ? null : 'IRREGULAR';
    statusFilter.value = quick === 'IRREGULAR' ? 'IRREGULAR' : '';
    renderAll();
  });
  
  $('#kpi-atencao').addEventListener('click', () => {
    quick = quick === 'ATENCAO' ? null : 'ATENCAO';
    statusFilter.value = quick === 'ATENCAO' ? 'ATENCAO' : '';
    renderAll();
  });
}

function renderTable() {
  const filtered = state.empresas.filter(matchAllCadastro);
  
  tblHead.innerHTML = '<tr><th>Empresa</th><th>CNPJ</th><th>IE</th><th>Federal</th><th>Estadual</th><th>Municipal</th><th>FGTS</th><th style="width:70px">A√ß√µes</th></tr>';
  
  if (filtered.length === 0) {
    tblBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 24px; color: var(--muted);">Nenhum registro encontrado</td></tr>';
    return;
  }
  
  const rows = filtered.map(e => {
    const key = keyOf(e);
    
    return `<tr>
      <td class="empresa-cell">
        <span class="empresa-name">${e.empresa}</span>
        <div class="sub">
          <div class="local-info">${e.municipio}/${e.uf}</div>
          <div class="ie-info">IE: ${e.inscricao_estadual || '‚Äî'}</div>
        </div>
      </td>
      <td class="cnpj-cell">${fmtCNPJ(e.cnpj)}</td>
      <td>${e.inscricao_estadual || '‚Äî'}</td>
      <td>${statusBadge(rowStatus(key, 'federal'))}</td>
      <td>${statusBadge(rowStatus(key, 'estadual'))}</td>
      <td>${statusBadge(rowStatus(key, 'municipal'))}</td>
      <td>${statusBadge(rowStatus(key, 'fgts'))}</td>
      <td class="row-actions">
        <button data-key="${key}" class="btnEditar btn-ghost btn-icon" title="Editar CND">‚úèÔ∏è</button>
        <button data-key="${key}" class="btnEditEmp btn-ghost btn-icon" title="Editar Cadastro">üìù</button>
      </td>
    </tr>`;
  }).join('');
  
  tblBody.innerHTML = rows;
  
  // Adicionar eventos aos bot√µes
  $$('.btnEditar').forEach(b => {
    b.addEventListener('click', () => openModalCND(b.dataset.key));
  });
  
  $$('.btnEditEmp').forEach(b => {
    b.addEventListener('click', () => openModalEmpresa(b.dataset.key));
  });
}

function renderAll() {
  renderKPIs();
  renderTable();
  if ($('#view-dashboard').style.display === 'block') {
    renderCharts();
  }
}

// ===== Exporta√ß√£o =====
function exportCSV() {
  const rows = [['Empresa', 'CNPJ', 'Munic√≠pio', 'UF', 'IE', 'Federal', 'Estadual', 'Municipal', 'FGTS']];
  
  state.empresas.forEach(e => {
    const key = keyOf(e);
    rows.push([
      e.empresa,
      fmtCNPJ(e.cnpj),
      e.municipio,
      e.uf,
      e.inscricao_estadual || '',
      rowStatus(key, 'federal'),
      rowStatus(key, 'estadual'),
      rowStatus(key, 'municipal'),
      rowStatus(key, 'fgts')
    ]);
  });
  
  const csv = rows.map(r => r.map(v => `"${String(v).replace('"', '""')}"`).join(';')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'cnds_export.csv';
  a.click();
  URL.revokeObjectURL(url);
  showToast('CSV exportado com sucesso');
}

function exportXLS() {
  let html = '<table><tr><th>Empresa</th><th>CNPJ</th><th>Munic√≠pio</th><th>UF</th><th>IE</th><th>Federal</th><th>Estadual</th><th>Municipal</th><th>FGTS</th></tr>';
  
  state.empresas.forEach(e => {
    const key = keyOf(e);
    html += `<tr>
      <td>${e.empresa}</td>
      <td>${fmtCNPJ(e.cnpj)}</td>
      <td>${e.municipio}</td>
      <td>${e.uf}</td>
      <td>${e.inscricao_estadual || ''}</td>
      <td>${rowStatus(key, 'federal')}</td>
      <td>${rowStatus(key, 'estadual')}</td>
      <td>${rowStatus(key, 'municipal')}</td>
      <td>${rowStatus(key, 'fgts')}</td>
    </tr>`;
  });
  
  html += '</table>';
  
  const blob = new Blob([`\uFEFF<html><head><meta charset="utf-8"/></head><body>${html}</body></html>`], { type: 'application/vnd.ms-excel' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'cnds_export.xls';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Excel exportado com sucesso');
}

// ===== Backup autom√°tico =====
let backupHandle = null;

async function pickBackupFile() {
  try {
    if (!window.showSaveFilePicker) {
      alert('Seu navegador n√£o oferece File System Access API. Use o bot√£o de backup JSON tradicional.');
      return;
    }
    
    backupHandle = await window.showSaveFilePicker({
      suggestedName: 'cnds_backup.json',
      types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }]
    });
    
    const writable = await backupHandle.createWritable();
    await writable.write(JSON.stringify(state, null, 2));
    await writable.close();
    
    showToast('Backup autom√°tico ativado');
  } catch(e) {
    console.warn(e);
  }
}

async function autoSave() {
  try {
    if (!backupHandle) return;
    const writable = await backupHandle.createWritable();
    await writable.write(JSON.stringify(state, null, 2));
    await writable.close();
  } catch(e) {
    console.warn('Falha no backup autom√°tico:', e.message);
  }
}

// ===== Dashboard =====
function drawBar(ctx, labels, values, colors) {
  const dpr = window.devicePixelRatio || 1;
  const rect = ctx.canvas.getBoundingClientRect();
  
  ctx.canvas.width = rect.width * dpr;
  ctx.canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  
  const padding = 40;
  const chartWidth = rect.width - padding * 2;
  const chartHeight = rect.height - padding * 2;
  
  const maxValue = Math.max(...values, 1);
  const barWidth = Math.max(20, chartWidth / labels.length * 0.7);
  const barHeightRatio = chartHeight / maxValue;
  
  ctx.clearRect(0, 0, rect.width, rect.height);
  
  // Desenhar barras
  labels.forEach((label, i) => {
    const barHeight = values[i] * barHeightRatio;
    const x = padding + i * (chartWidth / labels.length) + (chartWidth / labels.length - barWidth) / 2;
    const y = padding + chartHeight - barHeight;
    
    ctx.fillStyle = colors[i % colors.length];
    ctx.fillRect(x, y, barWidth, barHeight);
    
    // Valor
    ctx.fillStyle = '#0F172A';
    ctx.font = '12px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText(values[i], x + barWidth / 2, y - 5);
    
    // R√≥tulo
    ctx.fillText(label, x + barWidth / 2, padding + chartHeight + 15);
  });
}

function computeStatusCounts() {
  const items = state.empresas;
  let reg = 0, irr = 0, ate = 0, nao = 0;
  
  items.forEach(e => {
    const key = keyOf(e);
    const statuses = GROUPS.map(g => rowStatus(key, g));
    
    if (statuses.includes('IRREGULAR')) irr++;
    else if (statuses.some(s => isAtencao(s))) ate++;
    else if (statuses.includes('REGULAR')) reg++;
    else nao++;
  });
  
  return { reg, irr, ate, nao };
}

function computeUFCounts() {
  const map = {};
  
  state.empresas.forEach(e => {
    if (e.uf) {
      map[e.uf] = (map[e.uf] || 0) + 1;
    }
  });
  
  const pairs = Object.entries(map).sort((a, b) => b[1] - a[1]).slice(0, 12);
  return { labels: pairs.map(p => p[0]), values: pairs.map(p => p[1]) };
}

function renderCharts() {
  const st = computeStatusCounts();
  const labels = ['REGULAR', 'IRREGULAR', 'ATEN√á√ÉO', 'N√ÉO VERIF.'];
  const values = [st.reg, st.irr, st.ate, st.nao];
  const colors = ['#059669', '#DC2626', '#FF6B00', '#94A3B8'];
  
  const statusCtx = $('#chartStatus').getContext('2d');
  drawBar(statusCtx, labels, values, colors);
  
  const uf = computeUFCounts();
  const ufCtx = $('#chartUF').getContext('2d');
  drawBar(ufCtx, uf.labels, uf.values, Array(uf.labels.length).fill('#0033A0'));
}

// ===== Event Listeners =====
document.getElementById('btnNovo').addEventListener('click', () => openModalEmpresa(null));
document.getElementById('btnExportCSV').addEventListener('click', exportCSV);
document.getElementById('btnExportXLS').addEventListener('click', exportXLS);
document.getElementById('btnExport').addEventListener('click', () => {
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'cnds_backup.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Backup exportado com sucesso');
});
document.getElementById('btnAutoBackup').addEventListener('click', pickBackupFile);
document.getElementById('btnImport').addEventListener('click', () => document.getElementById('importFile').click());
document.getElementById('btnRescue').addEventListener('click', () => {
  const cands = scanCandidates();
  if (cands.length > 1) {
    // Implementar modal de sele√ß√£o se houver m√∫ltiplas op√ß√µes
    showToast('Use "Carregar backup" para dados antigos');
  } else if (cands.length === 1) {
    state = migrateIfNeeded(load(cands[0].key));
    save(STORAGE_MASTER_KEY, state);
    renderAll();
    showToast('Dados recuperados');
  } else {
    alert('Nenhum dado antigo encontrado.');
  }
});

document.getElementById('importFile').addEventListener('change', (ev) => {
  const file = ev.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const obj = JSON.parse(reader.result);
      if (!obj.empresas || !obj.cnds) throw new Error('Estrutura inv√°lida');
      
      state = migrateIfNeeded(obj);
      save(STORAGE_MASTER_KEY, state);
      renderAll();
      refreshEmpresaFilter();
      showToast('Backup carregado com sucesso');
    } catch(e) {
      alert('Arquivo inv√°lido: ' + e.message);
    }
  };
  reader.readAsText(file);
});

// Filtros
q.addEventListener('input', renderAll);
ufFilter.addEventListener('change', renderAll);
empresaFilter.addEventListener('change', renderAll);
tipoCND.addEventListener('change', renderAll);
statusFilter.addEventListener('change', () => {
  quick = null;
  renderAll();
});
modeSel.addEventListener('change', renderAll);

document.getElementById('btnLimpar').addEventListener('click', () => {
  q.value = '';
  ufFilter.value = '';
  empresaFilter.value = '';
  tipoCND.value = '';
  statusFilter.value = '';
  quick = null;
  renderAll();
});

// Mobile menu
document.getElementById('btnMobileMenu').addEventListener('click', () => {
  document.getElementById('mobileMenuContent').classList.toggle('show');
});

// Mobile buttons
document.getElementById('btnNovoMobile').addEventListener('click', () => openModalEmpresa(null));
document.getElementById('btnExportXLSMobile').addEventListener('click', exportXLS);
document.getElementById('btnExportCSVMobile').addEventListener('click', exportCSV);
document.getElementById('btnExportMobile').addEventListener('click', () => document.getElementById('btnExport').click());
document.getElementById('btnAutoBackupMobile').addEventListener('click', pickBackupFile);
document.getElementById('btnImportMobile').addEventListener('click', () => document.getElementById('importFile').click());
document.getElementById('btnRescueMobile').addEventListener('click', () => document.getElementById('btnRescue').click());

// Inicializa√ß√£o
renderAll();

// Formata√ß√£o autom√°tica do CNPJ
document.getElementById('me_cnpj').addEventListener('input', function(e) {
  let value = onlyDigits(e.target.value);
  if (value.length > 14) value = value.slice(0, 14);
  e.target.value = fmtCNPJ(value);
});
  </script>
</body>
</html>
